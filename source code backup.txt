/* Premise: this WebView2 browser was A) first downloaded from a source code of github; B) vibe-coded, rewritten, and then reviewed by Copilot, Gemini, and Chatgpt; C) I tried to customize a bit, based on my little knowledge of C++. */
#include <windows.h>
#include <wrl.h>
#include <WebView2.h>
#include <commctrl.h>
#include <commdlg.h> // For GetSaveFileName
#include <string>
#include <shlwapi.h>
#include <stdio.h> 
#include <algorithm> 
#include <fstream>   
#include <sstream>   
#include <vector>
#include <utility> 

// *** REQUIRED FOR COM/WEBVIEW2 INITIALIZATION ***
#include <objbase.h> 

#pragma comment(lib, "user32.lib")
#pragma comment(lib, "gdi32.lib")
#pragma comment(lib, "comctl32.lib")
#pragma comment(lib, "comdlg32.lib") // For GetSaveFileName
#pragma comment(lib, "WebView2LoaderStatic.lib") 
#pragma comment(lib, "shlwapi.lib")
#pragma comment(lib, "ole32.lib") // Required for CoInitializeEx

// Enable Visual Styles
#pragma comment(linker,"\"/manifestdependency:type='win32' \
name='Microsoft.Windows.Common-Controls' version='6.0.0.0' \
processorArchitecture='*' publicKeyToken='6595b64144ccf1df' language='*'\"")

using namespace Microsoft::WRL;
using namespace std;

// --- 1. Constants and IDs ---
#define WINDOW_WIDTH 1300 
#define WINDOW_HEIGHT 700 
#define PADDING 5
#define BUTTON_WIDTH 60
#define BUTTON_HEIGHT 24
#define GO_BUTTON_WIDTH 60
#define TOOLBAR_HEIGHT (BUTTON_HEIGHT + 2 * PADDING) 
#define STATUSBAR_HEIGHT 24
#define STATUS_PARTS 3

// Control IDs (IDs are fixed)
#define IDC_URL_BAR 101
#define IDC_GO_BUTTON 102
#define IDC_BACK_BUTTON 103
#define IDC_FORWARD_BUTTON 104
#define IDC_REFRESH_BUTTON 105
#define IDC_HOME_BUTTON 106
#define IDC_STOP_BUTTON 107
#define IDC_HISTORY_BUTTON 109
#define IDC_FAVORITES_BUTTON 110
#define IDC_SETTINGS_BUTTON 111

// Settings Window Control IDs
#define IDD_SETTINGS_DIALOG 300 
#define IDC_SETTINGS_HEADER 301
#define IDC_CHECK_BLOCK_POPUPS 302
#define IDC_CHECK_TRACKING_PREVENTION 303 
#define IDC_CHECK_CUSTOM_UA 304       
#define IDC_UA_LABEL 305              
#define IDC_UA_EDIT_BOX 306           
#define IDC_CHECK_TRACKING_PREVENTION 307  
#define IDC_STATIC_HISTORY_DISABLED 308    

// NEW CHECKBOX IDs for togglable settings

#define IDC_CHECK_SCRIPT_ENABLED 309

#define IDC_CHECK_SCRIPT_DIALOGS 310

#define IDC_CHECK_PASSWORD_SAVE 311

#define IDC_CHECK_AUTOFILL 312



// NEW PERMISSION CHECKBOX IDs

#define IDC_CHECK_BLOCK_NOTIFICATIONS 313

#define IDC_CHECK_BLOCK_LOCATION 314

#define IDC_CHECK_BLOCK_WEBCAM 315

#define IDC_CHECK_BLOCK_MICROPHONE 316



// NEW DOWNLOAD RADIO BUTTON IDs

#define IDC_RADIO_DOWNLOAD_ALLOW 317
#define IDC_RADIO_DOWNLOAD_BLOCK 318
#define IDC_RADIO_DOWNLOAD_PROMPT 319





// File Name for Persistence

#define SETTINGS_FILE_NAME L"settings.cfg" 



// Menu IDs (IDs are fixed)

#define IDM_FILE_EXIT 204

#define IDM_HELP_ABOUT 207



// --- 2. Global Variables ---

HWND g_hwndMain = nullptr;

HWND g_hwndUrlBar = nullptr;

HWND g_hwndStatusBar = nullptr;



HWND g_hwndBackButton = nullptr;

HWND g_hwndForwardButton = nullptr;

HWND g_hwndGoButton = nullptr; 

HWND g_hwndStopButton = nullptr;

HWND g_hwndRefreshButton = nullptr;

HWND g_hwndHomeButton = nullptr;

HWND g_hwndHistoryButton = nullptr;

HWND g_hwndFavoritesButton = nullptr;

HWND g_hwndSettingsButton = nullptr;



ComPtr<ICoreWebView2> g_webView;

ComPtr<ICoreWebView2Controller> g_controller;



HBRUSH g_hbrWhiteBackground = nullptr;

HWND g_hwndSettings = nullptr;

HWND g_hwndHistory = nullptr; 

HWND g_hwndFavorites = nullptr; 



// Browser State Flags (Persisted in settings.cfg)

bool g_blockPopups = true; 

bool g_trackingPrevention = false; 

bool g_customUserAgentEnabled = true; 

bool g_enableTrackingPrevention = true; 



// NEW TOGGLE STATES (Defaulting to current secure settings)

bool g_isScriptEnabled = true; // Scripts are enabled by default

bool g_areDefaultScriptDialogsEnabled = false; // Dialogs are disabled by default

bool g_isPasswordAutosaveEnabled = false; // Password save is disabled by default

bool g_isGeneralAutofillEnabled = false; // General autofill is disabled by default



// NEW PERMISSION STATES

bool g_blockNotifications = true;

bool g_blockLocation = true;

bool g_blockWebcam = true;

bool g_blockMicrophone = true;



// NEW DOWNLOAD BEHAVIOR

enum DownloadBehavior {Prompt, Block};

DownloadBehavior g_downloadBehavior = Prompt;





wstring g_customUserAgentString = L"Mozilla/5.0 (Windows NT 10.0; Win64; x64) FlameDarkness/0.9";

// Track current navigation context
wstring g_currentUrl = L"";
wstring g_currentTitle = L"";

// --- 3. Function Declarations ---
LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam);
LRESULT CALLBACK SettingsWindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam); 

void CreateBrowserControls(HWND hwnd);
void LayoutToolbarControls(HWND hwnd, int windowWidth); 
void ResizeWebView();
void NavigateToUrl(const wchar_t* url);
void InitializeWebView2(HWND hwnd);
void ShowSettingsWindow(HWND hParent); 
void ShowHistoryWindow(HWND hParent);
void ShowFavoritesWindow(HWND hParent);
void ApplySettingsToWebView();

void InitializeBrowserState(); 
void SaveFileSettings();    
void LoadFileSettings();    


// --- 4. Persistence Functions (File I/O for Settings) ---

void SaveFileSettings() {
    wofstream outFile(SETTINGS_FILE_NAME);
    if (outFile.is_open()) {
        outFile << L"Popups_Blocked=" << (g_blockPopups ? 1 : 0) << L"\n";
        outFile << L"DNT_Enabled=" << (g_trackingPrevention ? 1 : 0) << L"\n";
        outFile << L"UA_Enabled=" << (g_customUserAgentEnabled ? 1 : 0) << L"\n";
        outFile << L"TrackingPrevention_Active=" << (g_enableTrackingPrevention ? 1 : 0) << L"\n"; 
        outFile << L"Custom_UserAgent=" << g_customUserAgentString << L"\n";
        // NEW SETTINGS SAVED
        outFile << L"Script_Enabled=" << (g_isScriptEnabled ? 1 : 0) << L"\n";
        outFile << L"ScriptDialogs_Enabled=" << (g_areDefaultScriptDialogsEnabled ? 1 : 0) << L"\n";
        outFile << L"PasswordAutosave_Enabled=" << (g_isPasswordAutosaveEnabled ? 1 : 0) << L"\n";
        outFile << L"GeneralAutofill_Enabled=" << (g_isGeneralAutofillEnabled ? 1 : 0) << L"\n";
		// NEW PERMISSIONS
		outFile << L"Block_Notifications=" << (g_blockNotifications ? 1 : 0) << L"\n";
		outFile << L"Block_Location=" << (g_blockLocation ? 1 : 0) << L"\n";
		outFile << L"Block_Webcam=" << (g_blockWebcam ? 1 : 0) << L"\n";
		outFile << L"Block_Microphone=" << (g_blockMicrophone ? 1 : 0) << L"\n";
		// NEW DOWNLOAD BEHAVIOR
		outFile << L"Download_Behavior=" << static_cast<int>(g_downloadBehavior) << L"\n";
        outFile.close();
    }
}

void LoadFileSettings() {
    wifstream inFile(SETTINGS_FILE_NAME);
    if (inFile.is_open()) {
        wstring line;
        while (getline(inFile, line)) {
            size_t pos = line.find(L'=');
            if (pos != wstring::npos) {
                wstring key = line.substr(0, pos);
                wstring value = line.substr(pos + 1);

                if (key == L"Popups_Blocked") {
                    g_blockPopups = (value == L"1");
                } else if (key == L"DNT_Enabled") {
                    g_trackingPrevention = (value == L"1");
                } else if (key == L"UA_Enabled") {
                    g_customUserAgentEnabled = (value == L"1");
                } else if (key == L"TrackingPrevention_Active") {
                    g_enableTrackingPrevention = (value == L"1");
                } else if (key == L"Custom_UserAgent") {
                    g_customUserAgentString = value;
                }
                // NEW SETTINGS LOADED
                else if (key == L"Script_Enabled") {
                    g_isScriptEnabled = (value == L"1");
                } else if (key == L"ScriptDialogs_Enabled") {
                    g_areDefaultScriptDialogsEnabled = (value == L"1");
                } else if (key == L"PasswordAutosave_Enabled") {
                    g_isPasswordAutosaveEnabled = (value == L"1");
                } else if (key == L"GeneralAutofill_Enabled") {
                    g_isGeneralAutofillEnabled = (value == L"1");
                }
				// NEW PERMISSIONS
				else if (key == L"Block_Notifications") {
					g_blockNotifications = (value == L"1");
				} else if (key == L"Block_Location") {
					g_blockLocation = (value == L"1");
				} else if (key == L"Block_Webcam") {
					g_blockWebcam = (value == L"1");
				} else if (key == L"Block_Microphone") {
					g_blockMicrophone = (value == L"1");
				}
				// NEW DOWNLOAD BEHAVIOR
				else if (key == L"Download_Behavior") {
					try {
						g_downloadBehavior = static_cast<DownloadBehavior>(std::stoi(value));
					} catch (...) {
						g_downloadBehavior = Prompt; // Default to prompt on error
					}
				}
            }
        }
        inFile.close();
    } 
}

void InitializeBrowserState() {
    LoadFileSettings();
}

// --- 5. WebView2 Initialization and Handlers ---

void ApplySettingsToWebView() {
    if (!g_webView) return;

    ComPtr<ICoreWebView2Settings> settings;
    if (SUCCEEDED(g_webView->get_Settings(&settings))) {
        
        // --- Core Settings (Script/Host) ---
        settings->put_IsScriptEnabled(g_isScriptEnabled ? TRUE : FALSE); 
        settings->put_AreDefaultScriptDialogsEnabled(g_areDefaultScriptDialogsEnabled ? TRUE : FALSE);         
        settings->put_AreHostObjectsAllowed(FALSE);         

        // --- Settings2 (User Agent) ---
        ComPtr<ICoreWebView2Settings2> settings2;
        if (SUCCEEDED(settings.As(&settings2))) {
            if (g_customUserAgentEnabled) {
                settings2->put_UserAgent(g_customUserAgentString.c_str());
            } else {
                settings2->put_UserAgent(L"");
            }
        }


        void SetTrackingPreventionPolicy(void); {
        ComPtr<ICoreWebView2EnvironmentOptions5> g_settings;
            if (g_settings) {
                // This is for tracking prevention.
                g_settings->put_EnableTrackingPrevention(g_enableTrackingPrevention ? TRUE : FALSE);
            }
        }

        /* --- Settings3 (Third-Party Cookies Blocking) but non-functional ---
        ComPtr<ICoreWebView2Settings3> settings3;
        if (SUCCEEDED(settings.As(&settings3))) {
             settings3->put_IsThirdPartyCookiesBlocked(g_enableTrackingPrevention ? TRUE : FALSE);
        }*/
        
        // --- Settings4 (Autofill/Password Security) ---
        ComPtr<ICoreWebView2Settings4> settings4;
        if (SUCCEEDED(settings.As(&settings4))) {
            settings4->put_IsPasswordAutosaveEnabled(g_isPasswordAutosaveEnabled ? TRUE : FALSE); 
            settings4->put_IsGeneralAutofillEnabled(g_isGeneralAutofillEnabled ? TRUE : FALSE);  
        }
    }
}


void InitializeWebView2(HWND hwnd) {
    CreateCoreWebView2EnvironmentWithOptions(nullptr, nullptr, nullptr,
        Callback<ICoreWebView2CreateCoreWebView2EnvironmentCompletedHandler>(
            [hwnd](HRESULT result, ICoreWebView2Environment* env) -> HRESULT {
                env->CreateCoreWebView2Controller(hwnd,
                    Callback<ICoreWebView2CreateCoreWebView2ControllerCompletedHandler>(
                        [](HRESULT result, ICoreWebView2Controller* controller) -> HRESULT {
                            if (controller != nullptr) {
                                g_controller = controller;
                                g_controller->get_CoreWebView2(&g_webView);
                                
                                EventRegistrationToken token;
                                
                                ApplySettingsToWebView();

                                // Source Changed Handler (Updates URL Bar and global URL)
                                g_webView->add_SourceChanged(Callback<ICoreWebView2SourceChangedEventHandler>(
                                    [](ICoreWebView2* webview, ICoreWebView2SourceChangedEventArgs* args) -> HRESULT {
                                        LPWSTR uri;
                                        webview->get_Source(&uri);
                                        if (uri != nullptr) {
                                            SetWindowText(g_hwndUrlBar, uri);
                                            g_currentUrl = uri; 
                                            CoTaskMemFree(uri);
                                        }
                                        return S_OK;
                                    }).Get(), &token);

                                // Title Changed Handler (Updates Main Window Title)
                                g_webView->add_DocumentTitleChanged(Callback<ICoreWebView2DocumentTitleChangedEventHandler>(
                                    [](ICoreWebView2* webview, IUnknown* args) -> HRESULT {
                                        LPWSTR title;
                                        webview->get_DocumentTitle(&title);
                                        if (title != nullptr) {
                                            wchar_t windowTitle[256];
                                            swprintf_s(windowTitle, 256, L"FlameDarkness Browser Beta 0.9 -- Made by Local83 on 7 November 2025", title);
                                            SetWindowText(g_hwndMain, windowTitle);
                                            g_currentTitle = title; 
                                            CoTaskMemFree(title);
                                        }
                                        return S_OK;
                                    }).Get(), &token);

                                // Navigation Complete Handler (Updates Status Bar)
                                g_webView->add_NavigationCompleted(Callback<ICoreWebView2NavigationCompletedEventHandler>(
                                    [](ICoreWebView2* webview, ICoreWebView2NavigationCompletedEventArgs* args) -> HRESULT {
                                        BOOL success;
                                        args->get_IsSuccess(&success);
                                        
                                        if (success) {
                                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Done");
                                        } else {
                                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Navigation failed");
                                        }
                                        return S_OK;
                                    }).Get(), &token);
                                
                                // Pop-up Blocker
                                g_webView->add_NewWindowRequested(Callback<ICoreWebView2NewWindowRequestedEventHandler>(
                                    [](ICoreWebView2* webview, ICoreWebView2NewWindowRequestedEventArgs* args) -> HRESULT {
                                        if (g_blockPopups) {
                                            args->put_Handled(TRUE);
                                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Pop-up window blocked.");
                                        } 
                                        return S_OK;
                                    }).Get(), &token);

								
								// NEW: Permission Handler
								g_webView->add_PermissionRequested(Callback<ICoreWebView2PermissionRequestedEventHandler>(
									[](ICoreWebView2* webview, ICoreWebView2PermissionRequestedEventArgs* args) -> HRESULT {
										COREWEBVIEW2_PERMISSION_KIND kind;
										args->get_PermissionKind(&kind);

										bool do_block = false;
										LPCWSTR message = L"";

										switch (kind) {
                                            // It cannot find the permissions for notifications.
											case COREWEBVIEW2_PERMISSION_KIND_NOTIFICATIONS:
												if (g_blockNotifications) {
													do_block = true;
													message = L"Notification permission blocked.";
												}
												break;
											case COREWEBVIEW2_PERMISSION_KIND_GEOLOCATION:
												if (g_blockLocation) {
													do_block = true;
													message = L"Location permission blocked.";
												}
												break;
											case COREWEBVIEW2_PERMISSION_KIND_CAMERA:
												if (g_blockWebcam) {
													do_block = true;
													message = L"Webcam permission blocked.";
												}
												break;
											case COREWEBVIEW2_PERMISSION_KIND_MICROPHONE:
												if (g_blockMicrophone) {
													do_block = true;
													message = L"Microphone permission blocked.";
												}
												break;
											default:
												// For other permissions, use default behavior.
												args->put_State(COREWEBVIEW2_PERMISSION_STATE_DEFAULT);
												return S_OK;
										}

										if (do_block) {
											args->put_State(COREWEBVIEW2_PERMISSION_STATE_DENY);
											SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)message);
										} else {
											// You might want to prompt the user here instead of always allowing
											args->put_State(COREWEBVIEW2_PERMISSION_STATE_ALLOW);
										}
										
										return S_OK;
									}).Get(), &token);

                                    /*

								// NEW: Download Handler but Not Working because it cannot find "add_DownloadStarting"

								g_webView->add_DownloadStarting(Callback<ICoreWebView2DownloadStartingEventHandler>(
									[](ICoreWebView2* webview, ICoreWebView2DownloadStartingEventArgs* args) -> HRESULT {
										switch (g_downloadBehavior) {
											case Block: {
												args->put_Cancel(TRUE);
												SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Download blocked.");
												return S_OK;
											}
											case Prompt: {
												args->put_Handled(TRUE);
												
												LPWSTR defaultPath;
												args->get_ResultFilePath(&defaultPath);

												wchar_t filePath[MAX_PATH];
												lstrcpynW(filePath, defaultPath, MAX_PATH);
												CoTaskMemFree(defaultPath);

												OPENFILENAMEW ofn = { 0 };
												ofn.lStructSize = sizeof(ofn);
												ofn.hwndOwner = g_hwndMain;
												ofn.lpstrFile = filePath;
												ofn.nMaxFile = MAX_PATH;
												ofn.lpstrFilter = L"All Files\0*.*\0";
												ofn.lpstrTitle = L"Save File As";
												ofn.Flags = OFN_OVERWRITEPROMPT | OFN_PATHMUSTEXIST | OFN_NOCHANGEDIR;

												if (GetSaveFileNameW(&ofn)) {
													args->put_ResultFilePath(filePath);
													SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Download started...");
												} else {
													// User cancelled.
													args->put_Cancel(TRUE);
													SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Download cancelled.");
												}
												return S_OK;
											}
											case Allow:
											default:
												// Do nothing, allow default behavior
												return S_OK;
										}
									}).Get(), &token);
                                */
                               // Default start page is a private European search engine.
                                g_webView->Navigate(L"https://qwant.com");
                                ResizeWebView();
                                g_controller->put_IsVisible(TRUE);
                            }
                            return S_OK;
                        }).Get());
                return S_OK;
            }).Get());
}


// --- 6. Settings Application, Creation, and Procedures ---

LRESULT CALLBACK SettingsWindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {
    switch (uMsg) {
        case WM_CLOSE: {
            SaveFileSettings(); 
            ShowWindow(hwnd, SW_HIDE);
            return 0;
        }
            
        case WM_COMMAND: {
            if (HIWORD(wParam) == BN_CLICKED) {
                HWND hCheckbox = (HWND)lParam;
                int controlId = LOWORD(wParam);
                bool isChecked = SendMessage(hCheckbox, BM_GETCHECK, 0, 0) == BST_CHECKED;

                if (controlId == IDC_CHECK_BLOCK_POPUPS) {
                    g_blockPopups = isChecked;
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockPopups ? L"Pop-up blocking ON" : L"Pop-up blocking OFF"));
                }
                else if (controlId == IDC_CHECK_TRACKING_PREVENTION) {
                    g_trackingPrevention = isChecked;
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_trackingPrevention ? L"Do Not Track Header ON (Inactive)" : L"Do Not Track Header OFF"));
                }
                else if (controlId == IDC_CHECK_CUSTOM_UA) {
                    g_customUserAgentEnabled = isChecked;
                    EnableWindow(GetDlgItem(hwnd, IDC_UA_EDIT_BOX), g_customUserAgentEnabled);
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_customUserAgentEnabled ? L"Custom User Agent ON" : L"Custom User Agent OFF"));
                }
                else if (controlId == IDC_CHECK_TRACKING_PREVENTION) { 
                    g_enableTrackingPrevention = isChecked;
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_enableTrackingPrevention ? L"Tracking Prevention On" : L"Tracking Prevention Off"));
                }
                else if (controlId == IDC_CHECK_SCRIPT_ENABLED) {
                    g_isScriptEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_isScriptEnabled ? L"JavaScript ON" : L"JavaScript OFF (High Security)"));
                }
                else if (controlId == IDC_CHECK_SCRIPT_DIALOGS) {
                    g_areDefaultScriptDialogsEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_areDefaultScriptDialogsEnabled ? L"Script Dialogs ON" : L"Script Dialogs OFF (Recommended)"));
                }
                else if (controlId == IDC_CHECK_PASSWORD_SAVE) {
                    g_isPasswordAutosaveEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_isPasswordAutosaveEnabled ? L"Password Save ON" : L"Password Save OFF (Recommended)"));
                }
                else if (controlId == IDC_CHECK_AUTOFILL) {
                    g_isGeneralAutofillEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_isGeneralAutofillEnabled ? L"General Autofill ON" : L"General Autofill OFF (Recommended)"));
                }
				
				// NEW PERMISSION HANDLERS
				else if (controlId == IDC_CHECK_BLOCK_NOTIFICATIONS) {
					g_blockNotifications = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockNotifications ? L"Notifications Blocked" : L"Notifications Allowed"));
				}
				else if (controlId == IDC_CHECK_BLOCK_LOCATION) {
					g_blockLocation = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockLocation ? L"Location Access Blocked" : L"Location Access Allowed"));
				}
				else if (controlId == IDC_CHECK_BLOCK_WEBCAM) {
					g_blockWebcam = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockWebcam ? L"Webcam Access Blocked" : L"Webcam Access Allowed"));
				}
				else if (controlId == IDC_CHECK_BLOCK_MICROPHONE) {
					g_blockMicrophone = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockMicrophone ? L"Microphone Access Blocked" : L"Microphone Access Allowed"));
				}
				// NEW DOWNLOAD BEHAVIOR HANDLERS
				else if (controlId >= IDC_RADIO_DOWNLOAD_ALLOW && controlId <= IDC_RADIO_DOWNLOAD_PROMPT) {
                    if (isChecked) {
                        /*if (controlId == IDC_RADIO_DOWNLOAD_ALLOW) {
                            g_downloadBehavior = Allow; // The disable is because I think it would risk drive-by downloads.
                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Downloads: All Allowed");
                        }*/ if (controlId == IDC_RADIO_DOWNLOAD_PROMPT) {
                            g_downloadBehavior = Prompt;
                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Downloads: Prompt for location");
                        }
                            else if (controlId == IDC_RADIO_DOWNLOAD_BLOCK) {
                            g_downloadBehavior = Block;
                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Downloads: All Blocked");
                        }
                    }
                }
				
            } else if (HIWORD(wParam) == EN_CHANGE) {
                if (LOWORD(wParam) == IDC_UA_EDIT_BOX) {
                    wchar_t buffer[1024];
                    GetWindowTextW(GetDlgItem(hwnd, IDC_UA_EDIT_BOX), buffer, 1024);
                    g_customUserAgentString = buffer;
                    
                    if (g_customUserAgentEnabled) {
                        ApplySettingsToWebView();
                        SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"User Agent updated.");
                    }
                }
            }
            return 0;
        }
    }
    return DefWindowProc(hwnd, uMsg, wParam, lParam);
}

void ShowSettingsWindow(HWND hParent) {
    HINSTANCE hInst = (HINSTANCE)GetWindowLongPtr(hParent, GWLP_HINSTANCE);
    const wchar_t SETTINGS_CLASS_NAME[] = L"BrowserSettingsWindow";
    
    // Register the Settings Window Class once
    WNDCLASSW wc = { 
        0, SettingsWindowProc, 0, 0, hInst, LoadIcon(NULL, IDI_APPLICATION), 
        LoadCursor(NULL, IDC_ARROW), (HBRUSH)(COLOR_WINDOW + 1), nullptr, SETTINGS_CLASS_NAME
    };
    if (!GetClassInfoW(hInst, SETTINGS_CLASS_NAME, &wc)) RegisterClassW(&wc);

    if (!g_hwndSettings) {
        g_hwndSettings = CreateWindowExW(
            0, SETTINGS_CLASS_NAME, L"Settings - Security & Privacy", 
            WS_OVERLAPPEDWINDOW | WS_CAPTION | WS_SYSMENU | WS_MINIMIZEBOX,
            CW_USEDEFAULT, CW_USEDEFAULT, 450, 600, // Window height for my 1366x768 monitor size
            hParent, nullptr, hInst, nullptr
        );
        if (!g_hwndSettings) return;

        int y = PADDING * 3;

        // --- 1. General Header ---
        CreateWindow(L"STATIC", L"Security and Privacy Features", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_SETTINGS_HEADER, hInst, nullptr);
        y += 30;
        CreateWindow(L"STATIC", L"", WS_CHILD | WS_VISIBLE | SS_ETCHEDHORZ, 20, y, 400, 1, g_hwndSettings, nullptr, hInst, nullptr);
        y += PADDING * 3;

        // --- 2. Checkboxes ---
        
        // Pop-ups
        CreateWindow(L"BUTTON", L"Block pop-up windows (Recommended)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_POPUPS, hInst, nullptr);
        y += 30;

        // DNT
        CreateWindow(L"BUTTON", L"Enable 'Do Not Track' Header (Inactive)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_TRACKING_PREVENTION, hInst, nullptr);
        y += 30;

        // Tracking Prevention Button
        CreateWindow(L"BUTTON", L"Enable Tracking Prevention", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_TRACKING_PREVENTION, hInst, nullptr);
        y += 40; 
        
        // --- 3. Script Control Settings (NEW) ---
        CreateWindow(L"STATIC", L"Script and User Input Control", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_UA_LABEL, hInst, nullptr);
        y += 20;

        // NEW: Script Enabled
        CreateWindow(L"BUTTON", L"Enable JavaScript", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_SCRIPT_ENABLED, hInst, nullptr);
        y += 30;

        // NEW: Script Dialogs Enabled
        CreateWindow(L"BUTTON", L"Allow JavaScript Dialogs (Alert, Confirm, Prompt)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_SCRIPT_DIALOGS, hInst, nullptr);
        y += 30;

        // NEW: Password Autosave Enabled
        CreateWindow(L"BUTTON", L"Allow Password Autosave", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_PASSWORD_SAVE, hInst, nullptr);
        y += 30;

        // NEW: General Autofill Enabled
        CreateWindow(L"BUTTON", L"Allow General Autofill (Address, Credit Card)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_AUTOFILL, hInst, nullptr);
        y += 40;

		
		// --- NEW: Permissions Section ---
        CreateWindow(L"STATIC", L"Permission Control", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, nullptr, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Notifications", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_NOTIFICATIONS, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Location Access", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_LOCATION, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Webcam Access", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_WEBCAM, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Microphone Access", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_MICROPHONE, hInst, nullptr);
        y += 40;

        // --- NEW: Download Control Section ---
        CreateWindow(L"STATIC", L"Download Behavior", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, nullptr, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Allow all downloads", WS_CHILD | WS_VISIBLE | BS_AUTORADIOBUTTON | WS_GROUP, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_RADIO_DOWNLOAD_ALLOW, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block all downloads", WS_CHILD | WS_VISIBLE | BS_AUTORADIOBUTTON, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_RADIO_DOWNLOAD_BLOCK, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Prompt for where to save downloads", WS_CHILD | WS_VISIBLE | BS_AUTORADIOBUTTON, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_RADIO_DOWNLOAD_PROMPT, hInst, nullptr);
        y += 40;
		

        // --- 4. User Agent Section ---
        CreateWindow(L"STATIC", L"Custom Browser Identity (User Agent)", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_UA_LABEL, hInst, nullptr);
        y += 20;

        // Checkbox: Custom User Agent Enable
        CreateWindow(L"BUTTON", L"Override User Agent String", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_CUSTOM_UA, hInst, nullptr);
        y += 30;

        // Edit Box: User Agent String
        CreateWindowEx(WS_EX_CLIENTEDGE, L"EDIT", g_customUserAgentString.c_str(),
            WS_CHILD | WS_VISIBLE | ES_LEFT | ES_AUTOHSCROLL, 20, y, 400, 24, g_hwndSettings, (HMENU)IDC_UA_EDIT_BOX, hInst, nullptr);
        y += 40; 

        // --- 5. History/Favorites Disabled Section ---
        CreateWindow(L"STATIC", L"History and Favorites (Disabled for Security)", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_SETTINGS_HEADER, hInst, nullptr);
        y += 20;
        // Text explaining why it's disabled
        CreateWindow(L"STATIC", L"This feature is disabled due to WebView2's sandboxing model, which lowers security and privacy risks.", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 40, g_hwndSettings, (HMENU)IDC_STATIC_HISTORY_DISABLED, hInst, nullptr);
        y += 40; 
        /* Help/About section but not yet implemented.
        CreateWindow(L"STATIC", L"Help/About section.", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 40, g_hwndSettings, (HMENU)IDC_HELP_ABOUT, hInst, nullptr);
        y += 40; */


        // Apply font
        HFONT hFont = (HFONT)GetStockObject(SYSTEM_FONT);
        EnumChildWindows(g_hwndSettings, [](HWND hwndChild, LPARAM lParam) -> BOOL {
            SendMessage(hwndChild, WM_SETFONT, (WPARAM)lParam, TRUE);
            return TRUE;
        }, (LPARAM)hFont);
    }
    
    // Set toggle and permission states
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_POPUPS), BM_SETCHECK, g_blockPopups ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_TRACKING_PREVENTION), BM_SETCHECK, g_trackingPrevention ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_CUSTOM_UA), BM_SETCHECK, g_customUserAgentEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_TRACKING_PREVENTION), BM_SETCHECK, g_enableTrackingPrevention ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_SCRIPT_ENABLED), BM_SETCHECK, g_isScriptEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_SCRIPT_DIALOGS), BM_SETCHECK, g_areDefaultScriptDialogsEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_PASSWORD_SAVE), BM_SETCHECK, g_isPasswordAutosaveEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_AUTOFILL), BM_SETCHECK, g_isGeneralAutofillEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_NOTIFICATIONS), BM_SETCHECK, g_blockNotifications ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_LOCATION), BM_SETCHECK, g_blockLocation ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_WEBCAM), BM_SETCHECK, g_blockWebcam ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_MICROPHONE), BM_SETCHECK, g_blockMicrophone ? BST_CHECKED : BST_UNCHECKED, 0);

    // SET NEW DOWNLOAD BEHAVIOR
    CheckRadioButton(g_hwndSettings, IDC_RADIO_DOWNLOAD_ALLOW, IDC_RADIO_DOWNLOAD_PROMPT, 
        // g_downloadBehavior == Allow ? IDC_RADIO_DOWNLOAD_ALLOW : 
        g_downloadBehavior == Block ? IDC_RADIO_DOWNLOAD_BLOCK : 
        IDC_RADIO_DOWNLOAD_PROMPT);
	

    SetWindowTextW(GetDlgItem(g_hwndSettings, IDC_UA_EDIT_BOX), g_customUserAgentString.c_str());
    EnableWindow(GetDlgItem(g_hwndSettings, IDC_UA_EDIT_BOX), g_customUserAgentEnabled);

    ShowWindow(g_hwndSettings, SW_SHOW);
    SetForegroundWindow(g_hwndSettings);
}


// --- 7. Disabled Features ---

void ShowHistoryWindow(HWND hParent) {
    MessageBox(hParent, L"History logging is disabled for security and privacy reasons.", L"Feature Disabled", MB_OK | MB_ICONINFORMATION);
}

void ShowFavoritesWindow(HWND hParent) {
    MessageBox(hParent, L"The Favorites feature is disabled for security and privacy reasons.", L"Feature Disabled", MB_OK | MB_ICONINFORMATION);
}


// --- 8. Main Window Creation and Procedures ---

void NavigateToUrl(const wchar_t* url) {
    wstring s_url(url);
    // Default to HTTPS.
    if (s_url.find(L"://") == wstring::npos) {
        s_url = L"https://" + s_url;
    }
    if (g_webView) {
        g_webView->Navigate(s_url.c_str());
        SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Loading...");
    }
}

void CreateBrowserControls(HWND hwnd) {
    HINSTANCE hInst = (HINSTANCE)GetWindowLongPtr(hwnd, GWLP_HINSTANCE);
    
    // Create Toolbar buttons
    int x = PADDING;
    g_hwndBackButton = CreateWindow(L"BUTTON", L"<", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_BACK_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;
    g_hwndForwardButton = CreateWindow(L"BUTTON", L">", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_FORWARD_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;
    g_hwndRefreshButton = CreateWindow(L"BUTTON", L"Refresh", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_REFRESH_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;
    g_hwndHomeButton = CreateWindow(L"BUTTON", L"Home", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_HOME_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;

    // Create URL Bar (Edit Control)
    g_hwndUrlBar = CreateWindowEx(WS_EX_CLIENTEDGE, L"EDIT", L"https://qwant.com", 
                                  WS_CHILD | WS_VISIBLE | ES_LEFT | ES_AUTOHSCROLL, 
                                  x, PADDING, 1, BUTTON_HEIGHT, hwnd, (HMENU)IDC_URL_BAR, hInst, 0);

    // Create GO Button
    g_hwndGoButton = CreateWindow(L"BUTTON", L"Go", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, GO_BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_GO_BUTTON, hInst, 0);

    // Create Feature Buttons
    int right_x = GetSystemMetrics(SM_CXSCREEN); 
    g_hwndSettingsButton = CreateWindow(L"BUTTON", L"Settings", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80, PADDING, 80, BUTTON_HEIGHT, hwnd, (HMENU)IDC_SETTINGS_BUTTON, hInst, 0);
    g_hwndFavoritesButton = CreateWindow(L"BUTTON", L"Favorites", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80 * 2 - PADDING, PADDING, 80, BUTTON_HEIGHT, hwnd, (HMENU)IDC_FAVORITES_BUTTON, hInst, 0);
    g_hwndHistoryButton = CreateWindow(L"BUTTON", L"History", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80 * 3 - PADDING * 2, PADDING, 80, BUTTON_HEIGHT, hwnd, (HMENU)IDC_HISTORY_BUTTON, hInst, 0);


    // Create Status Bar
    g_hwndStatusBar = CreateWindowEx(0, STATUSCLASSNAME, nullptr, 
                                     WS_CHILD | WS_VISIBLE | SBARS_SIZEGRIP, 
                                     0, 0, 0, 0, hwnd, nullptr, hInst, nullptr);
    int parts[STATUS_PARTS] = {100, 250, -1};
    SendMessage(g_hwndStatusBar, SB_SETPARTS, STATUS_PARTS, (LPARAM)parts);
    SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Ready");
    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Security Status: OK");
    SendMessage(g_hwndStatusBar, SB_SETTEXT, 2, (LPARAM)L"FlameDarkness Browser");

    // Apply font to controls
    // Use SYSTEM_FONT which is generally better for Unicode/Emoji support
    HFONT hFont = (HFONT)GetStockObject(SYSTEM_FONT);
    EnumChildWindows(hwnd, [](HWND hwndChild, LPARAM lParam) -> BOOL {
        SendMessage(hwndChild, WM_SETFONT, (WPARAM)lParam, TRUE);
        return TRUE;
    }, (LPARAM)hFont);
}

void LayoutToolbarControls(HWND hwnd, int windowWidth) {
    // Calculate total fixed width for buttons (4 Nav buttons + 3 Feature buttons)
    const int navButtonWidth = BUTTON_WIDTH * 4;
    const int navButtonPadding = PADDING * 5; 
    // Adjusted to 3 buttons of 80px width
    const int featureButtonTotalWidth = 80 * 3 + PADDING * 3; 

    const int urlBarStart = navButtonWidth + navButtonPadding;
    const int urlBarEnd = windowWidth - GO_BUTTON_WIDTH - PADDING - featureButtonTotalWidth;
    const int urlBarWidth = urlBarEnd - urlBarStart;

    // Reposition URL Bar and GO Button
    MoveWindow(g_hwndUrlBar, urlBarStart, PADDING, urlBarWidth, BUTTON_HEIGHT, TRUE);
    MoveWindow(g_hwndGoButton, urlBarStart + urlBarWidth + PADDING, PADDING, GO_BUTTON_WIDTH, BUTTON_HEIGHT, TRUE);

    // Reposition Feature Buttons (Fixed width 80px)
    int current_x = windowWidth - PADDING - 80;
    MoveWindow(g_hwndSettingsButton, current_x, PADDING, 80, BUTTON_HEIGHT, TRUE);
    
    current_x -= (80 + PADDING);
    MoveWindow(g_hwndFavoritesButton, current_x, PADDING, 80, BUTTON_HEIGHT, TRUE);

    current_x -= (80 + PADDING);
    MoveWindow(g_hwndHistoryButton, current_x, PADDING, 80, BUTTON_HEIGHT, TRUE);

}

void ResizeWebView() {
    if (g_controller) {
        RECT bounds;
        GetClientRect(g_hwndMain, &bounds);
        
        // Exclude Toolbar and Status Bar areas
        bounds.top += TOOLBAR_HEIGHT;
        bounds.bottom -= STATUSBAR_HEIGHT;
        
        g_controller->put_Bounds(bounds);
        
        // Move Status Bar to bottom
        MoveWindow(g_hwndStatusBar, 0, bounds.bottom, bounds.right, STATUSBAR_HEIGHT, TRUE);
    }
}


LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {
    switch (uMsg) {
        case WM_CREATE: {
            InitializeBrowserState();
            CreateBrowserControls(hwnd);
            InitializeWebView2(hwnd);
            break;
        }

        case WM_SIZE: {
            int width = LOWORD(lParam);
            LayoutToolbarControls(hwnd, width);
            ResizeWebView();
            break;
        }

        case WM_COMMAND: {
            int wmId = LOWORD(wParam);
            
            // Process button clicks
            switch (wmId) {
                case IDC_GO_BUTTON: {
                    wchar_t urlBuffer[2048];
                    GetWindowText(g_hwndUrlBar, urlBuffer, 2048);
                    NavigateToUrl(urlBuffer);
                    break;
                }
                case IDC_BACK_BUTTON:
                    if (g_webView) g_webView->GoBack();
                    break;
                case IDC_FORWARD_BUTTON:
                    if (g_webView) g_webView->GoForward();
                    break;
                case IDC_REFRESH_BUTTON:
                    if (g_webView) g_webView->Reload();
                    break;
                case IDC_HOME_BUTTON:
                    NavigateToUrl(L"https://qwant.com");
                    break;
                case IDC_HISTORY_BUTTON:
                    ShowHistoryWindow(hwnd); 
                    break;
                case IDC_FAVORITES_BUTTON:
                    ShowFavoritesWindow(hwnd); 
                    break;
                case IDC_SETTINGS_BUTTON:
                    ShowSettingsWindow(hwnd);
                    break;
                case IDM_FILE_EXIT:
                    DestroyWindow(hwnd);
                    break;
            }
            break;
        }

        case WM_CLOSE:
            DestroyWindow(hwnd);
            break;

        case WM_DESTROY:
            PostQuitMessage(0);
            break;

        default:
            return DefWindowProc(hwnd, uMsg, wParam, lParam);
    }
    return 0;
}

// --- 9. WinMain Entry Point ---

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    
    // Initialize common controls (status bar and others)
    INITCOMMONCONTROLSEX icc = { sizeof(INITCOMMONCONTROLSEX), ICC_BAR_CLASSES | ICC_STANDARD_CLASSES };
    InitCommonControlsEx(&icc);

    // *** FIX: Initialize COM (Critical for WebView2) ***
    HRESULT hr = CoInitializeEx(nullptr, COINIT_APARTMENTTHREADED);
    if (FAILED(hr)) {
        return 0; 
    }

    const wchar_t CLASS_NAME[] = L"BrowserWindowClass";

    // Register the main window class
    WNDCLASSW wc = {};
    wc.lpfnWndProc = WindowProc;
    wc.hInstance = hInstance;
    wc.lpszClassName = CLASS_NAME;
    wc.hIcon = LoadIcon(NULL, IDI_APPLICATION);
    wc.hCursor = LoadCursor(NULL, IDC_ARROW);
    wc.hbrBackground = (HBRUSH)GetStockObject(WHITE_BRUSH);
    
    if (!RegisterClassW(&wc)) {
        CoUninitialize(); // Uninitialize before returning
        return 0;
    }

    // Create the main window
    g_hwndMain = CreateWindowExW(
        0, CLASS_NAME, L"FlameDarkness Browser Beta 0.9 -- Made by Local83 on 7 November 2025",
        WS_OVERLAPPEDWINDOW,
        CW_USEDEFAULT, CW_USEDEFAULT, WINDOW_WIDTH, WINDOW_HEIGHT,
        nullptr, nullptr, hInstance, nullptr
    );

    if (!g_hwndMain) {
        CoUninitialize(); // Uninitialize before returning
        return 0;
    }

    ShowWindow(g_hwndMain, nCmdShow);
    UpdateWindow(g_hwndMain);

    // Message loop
    MSG msg = {};
    while (GetMessage(&msg, nullptr, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    // *** FIX: Uninitialize COM ***
    CoUninitialize();

    return 0;
}