/* Premise: this WebView2 browser was A) first downloaded from a source code of github; B) vibe-coded, rewritten, and then reviewed by Copilot, Gemini, and Chatgpt; C) I tried to customize a bit, based on my little knowledge of C++. */
#include <windows.h>
#include <wrl.h>
#include <WebView2.h>
#if defined(__has_include)
#  if __has_include("WebView2EnvironmentOptions.h")
#    include "WebView2EnvironmentOptions.h"
#    define HAVE_WEBVIEW2_ENV_OPTIONS 1
#  endif
#endif
#include <commctrl.h>
#include <commdlg.h> // For GetSaveFileName
#include <string>
#include <shlwapi.h>
#include <stdio.h> 
#include <algorithm> 
#include <fstream>   
#include <sstream>   
#include <vector>
#include <utility> 
#include <set>
#include <shellapi.h>
#include <urlmon.h>
#pragma comment(lib, "urlmon.lib")

// *** REQUIRED FOR COM/WEBVIEW2 INITIALIZATION ***
#include <objbase.h> 

#pragma comment(lib, "user32.lib")
#pragma comment(lib, "gdi32.lib")
#pragma comment(lib, "comctl32.lib")
#pragma comment(lib, "comdlg32.lib") // For GetSaveFileName
#pragma comment(lib, "WebView2LoaderStatic.lib") 
#pragma comment(lib, "shlwapi.lib")
#pragma comment(lib, "ole32.lib") // Required for CoInitializeEx

// Enable Visual Styles
#pragma comment(linker,"\"/manifestdependency:type='win32' \
name='Microsoft.Windows.Common-Controls' version='6.0.0.0' \
processorArchitecture='*' publicKeyToken='6595b64144ccf1df' language='*'\"")

using namespace Microsoft::WRL;
using namespace std;

// --- 1. Constants and IDs ---
#define WINDOW_WIDTH 1300 
#define WINDOW_HEIGHT 700 
#define PADDING 5
#define BUTTON_WIDTH 60
#define BUTTON_HEIGHT 24
#define GO_BUTTON_WIDTH 60
#define TOOLBAR_HEIGHT (BUTTON_HEIGHT + 2 * PADDING) 
#define STATUSBAR_HEIGHT 24
#define STATUS_PARTS 3
#define PRIVACY_BUTTON_WIDTH 120

// Control IDs (IDs are fixed)
#define IDC_URL_BAR 101
#define IDC_GO_BUTTON 102
#define IDC_BACK_BUTTON 103
#define IDC_FORWARD_BUTTON 104
#define IDC_REFRESH_BUTTON 105
#define IDC_HOME_BUTTON 106
#define IDC_STOP_BUTTON 107
#define IDC_HISTORY_BUTTON 109
#define IDC_ADBLOCKER_BUTTON 110
#define IDC_SETTINGS_BUTTON 111

// Settings Window Control IDs
#define IDD_SETTINGS_DIALOG 300 
#define IDC_SETTINGS_HEADER 301
#define IDC_CHECK_BLOCK_POPUPS 302
#define IDC_CHECK_DNT 303
#define IDC_CHECK_CUSTOM_UA 304       
#define IDC_UA_LABEL 305              
#define IDC_UA_EDIT_BOX 306           
#define IDC_CHECK_TRACKING_PREVENTION 307  
#define IDC_STATIC_HISTORY_DISABLED 308    
// #define IDC_HELP_ABOUT 320

// Additional feature buttons
#define IDC_HELP_BUTTON 321
#define IDC_PRIVACY_TEST_BUTTON 322

// NEW CHECKBOX IDs for togglable settings

#define IDC_CHECK_SCRIPT_ENABLED 309

#define IDC_CHECK_SCRIPT_DIALOGS 310

#define IDC_CHECK_PASSWORD_SAVE 311

#define IDC_CHECK_AUTOFILL 312



// NEW PERMISSION CHECKBOX IDs

#define IDC_CHECK_BLOCK_NOTIFICATIONS 313

#define IDC_CHECK_BLOCK_LOCATION 314

#define IDC_CHECK_BLOCK_WEBCAM 315

#define IDC_CHECK_BLOCK_MICROPHONE 316



// NEW DOWNLOAD RADIO BUTTON IDs

#define IDC_RADIO_DOWNLOAD_ALLOW 317
#define IDC_RADIO_DOWNLOAD_BLOCK 318
#define IDC_RADIO_DOWNLOAD_PROMPT 319

// New: Force HTTPS option
#define IDC_CHECK_FORCE_HTTPS 324





// File Name for Persistence

#define SETTINGS_FILE_NAME L"settings.cfg" 



// Menu IDs (IDs are fixed)

#define IDM_FILE_EXIT 204

#define IDM_HELP_ABOUT 207

// Ad-block menu commands
#define IDM_ADBLOCK_TOGGLE 400
#define IDM_ADBLOCK_RELOAD 401
#define IDM_ADBLOCK_LICENSE 402



// --- 2. Global Variables ---

HWND g_hwndMain = nullptr;

HWND g_hwndUrlBar = nullptr;

HWND g_hwndStatusBar = nullptr;



HWND g_hwndBackButton = nullptr;

HWND g_hwndForwardButton = nullptr;

HWND g_hwndGoButton = nullptr; 

HWND g_hwndStopButton = nullptr;

HWND g_hwndRefreshButton = nullptr;

HWND g_hwndHomeButton = nullptr;

HWND g_hwndHistoryButton = nullptr;

HWND g_hwndFavoritesButton = nullptr;

HWND g_hwndSettingsButton = nullptr;


// Help / Privacy buttons
HWND g_hwndHelpButton = nullptr;
HWND g_hwndPrivacyButton = nullptr;



ComPtr<ICoreWebView2> g_webView;

ComPtr<ICoreWebView2Controller> g_controller;



HBRUSH g_hbrWhiteBackground = nullptr;

HWND g_hwndSettings = nullptr;

HWND g_hwndHistory = nullptr; 

HWND g_hwndFavorites = nullptr; 



// Browser State Flags (Persisted in settings.cfg)

bool g_blockPopups = true; 

bool g_trackingPrevention = true; 

bool g_customUserAgentEnabled = true; 

bool g_enableTrackingPrevention = true; 

// Third-party cookie blocking toggle (requires newer WebView2 SDK/runtime)
// bool g_blockThirdPartyCookies = true;



// NEW TOGGLE STATES (Defaulting to current secure settings)

bool g_isScriptEnabled = true; // Scripts are enabled by default

bool g_areDefaultScriptDialogsEnabled = false; // Dialogs are disabled by default

bool g_isPasswordAutosaveEnabled = false; // Password save is disabled by default

bool g_isGeneralAutofillEnabled = false; // General autofill is disabled by default

// Force HTTPS navigation
bool g_forceHTTPS = true;



// NEW PERMISSION STATES

bool g_blockNotifications = true;

bool g_blockLocation = true;

bool g_blockWebcam = true;

bool g_blockMicrophone = true;



// NEW DOWNLOAD BEHAVIOR






wstring g_customUserAgentString = L"Mozilla/5.0 (Windows NT 10.0; Win64; x64) FlameDarkness/0.91";

// Track current navigation context
wstring g_currentUrl = L"";
wstring g_currentTitle = L"";

// Ad-blocker state and filters
bool g_adBlockEnabled = true;
std::vector<std::wstring> g_adblockSubstringFilters;
std::set<std::wstring> g_adblockHostFilters;

// --- 3. Function Declarations ---
LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam);
LRESULT CALLBACK SettingsWindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam); 

void CreateBrowserControls(HWND hwnd);
void LayoutToolbarControls(HWND hwnd, int windowWidth); 
void ResizeWebView();
void NavigateToUrl(const wchar_t* url);
void InitializeWebView2(HWND hwnd);
void ShowSettingsWindow(HWND hParent); 
void ShowHistoryWindow(HWND hParent);
void ShowFavoritesWindow(HWND hParent);
void ApplySettingsToWebView();
bool DownloadAndAggregateFilters(HWND hwnd);
void LoadAdBlockFilters();

void InitializeBrowserState(); 
void SaveFileSettings();    
void LoadFileSettings();    


// --- 4. Persistence Functions (File I/O for Settings) ---

void SaveFileSettings() {
    wofstream outFile(SETTINGS_FILE_NAME);
    if (outFile.is_open()) {
        outFile << L"Popups_Blocked=" << (g_blockPopups ? 1 : 0) << L"\n";
        outFile << L"DNT_Enabled=" << (g_trackingPrevention ? 1 : 0) << L"\n";
        outFile << L"UA_Enabled=" << (g_customUserAgentEnabled ? 1 : 0) << L"\n";
        outFile << L"TrackingPrevention_Active=" << (g_enableTrackingPrevention ? 1 : 0) << L"\n"; 
        outFile << L"Custom_UserAgent=" << g_customUserAgentString << L"\n";
        // NEW SETTINGS SAVED
        outFile << L"Script_Enabled=" << (g_isScriptEnabled ? 1 : 0) << L"\n";
        outFile << L"ScriptDialogs_Enabled=" << (g_areDefaultScriptDialogsEnabled ? 1 : 0) << L"\n";
        outFile << L"PasswordAutosave_Enabled=" << (g_isPasswordAutosaveEnabled ? 1 : 0) << L"\n";
        outFile << L"GeneralAutofill_Enabled=" << (g_isGeneralAutofillEnabled ? 1 : 0) << L"\n";
		// NEW PERMISSIONS
		outFile << L"Block_Notifications=" << (g_blockNotifications ? 1 : 0) << L"\n";
		outFile << L"Block_Location=" << (g_blockLocation ? 1 : 0) << L"\n";
		outFile << L"Block_Webcam=" << (g_blockWebcam ? 1 : 0) << L"\n";
		outFile << L"Block_Microphone=" << (g_blockMicrophone ? 1 : 0) << L"\n";
        // NEW: Force HTTPS setting
        outFile << L"Force_HTTPS=" << (g_forceHTTPS ? 1 : 0) << L"\n";
    // Note: download behavior UI removed when download interception is not supported by current WebView2 headers
        // AD-BLOCKER SETTING
        outFile << L"AdBlock_Enabled=" << (g_adBlockEnabled ? 1 : 0) << L"\n";
        outFile.close();
    }
}

void LoadFileSettings() {
    wifstream inFile(SETTINGS_FILE_NAME);
    if (inFile.is_open()) {
        wstring line;
        while (getline(inFile, line)) {
            size_t pos = line.find(L'=');
            if (pos != wstring::npos) {
                wstring key = line.substr(0, pos);
                wstring value = line.substr(pos + 1);

                if (key == L"Popups_Blocked") {
                    g_blockPopups = (value == L"1");
                } else if (key == L"DNT_Enabled") {
                    g_trackingPrevention = (value == L"1");
                } else if (key == L"UA_Enabled") {
                    g_customUserAgentEnabled = (value == L"1");
                } else if (key == L"TrackingPrevention_Active") {
                    g_enableTrackingPrevention = (value == L"1");
                } else if (key == L"Custom_UserAgent") {
                    g_customUserAgentString = value;
                }
                // NEW SETTINGS LOADED
                else if (key == L"Script_Enabled") {
                    g_isScriptEnabled = (value == L"1");
                } else if (key == L"ScriptDialogs_Enabled") {
                    g_areDefaultScriptDialogsEnabled = (value == L"1");
                } else if (key == L"PasswordAutosave_Enabled") {
                    g_isPasswordAutosaveEnabled = (value == L"1");
                } else if (key == L"GeneralAutofill_Enabled") {
                    g_isGeneralAutofillEnabled = (value == L"1");
                } else if (key == L"AdBlock_Enabled") {
                    g_adBlockEnabled = (value == L"1");
                }
				// NEW PERMISSIONS
				else if (key == L"Block_Notifications") {
					g_blockNotifications = (value == L"1");
				} else if (key == L"Block_Location") {
					g_blockLocation = (value == L"1");
				} else if (key == L"Block_Webcam") {
					g_blockWebcam = (value == L"1");
				} else if (key == L"Block_Microphone") {
					g_blockMicrophone = (value == L"1");
				}
                // NEW: Force HTTPS setting
                else if (key == L"Force_HTTPS") {
                    g_forceHTTPS = (value == L"1");
                }
            }
        }
        inFile.close();
    } 
}

void InitializeBrowserState() {
    LoadFileSettings();
    // Load ad-block filters (from disk if present otherwise use built-in set)
    LoadAdBlockFilters();
}

// Load ad-block filters into memory. Called at startup and after reload.
void LoadAdBlockFilters() {
    g_adblockHostFilters.clear();
    g_adblockSubstringFilters.clear();

    // Built-in host list (small built-in list)
    const wchar_t* builtin_hosts[] = {
        L"doubleclick.net",
        L"googlesyndication.com",
        L"adservice.google.com",
        L"ads.youtube.com",
        L"ads.google.com",
        L"adnxs.com",
        L"adsafeprotected.com",
        L"pagead2.googlesyndication.com",
        L"track.adform.net",
        L"tpc.googlesyndication.com"
    };
    for (const wchar_t* h : builtin_hosts) g_adblockHostFilters.insert(std::wstring(h));

    // Try to load a file named adblock_filters.txt next to the executable
    wchar_t modulePath[MAX_PATH] = {0};
    if (GetModuleFileNameW(NULL, modulePath, ARRAYSIZE(modulePath)) > 0) {
        PathRemoveFileSpecW(modulePath);
        wchar_t filterPath[MAX_PATH];
        PathCombineW(filterPath, modulePath, L"adblock_filters.txt");
        if (!PathFileExistsW(filterPath)) {
            // If the file is missing, offer to download well-known filter lists
            DownloadAndAggregateFilters(g_hwndMain);
        }
        if (PathFileExistsW(filterPath)) {
            std::wifstream in(filterPath);
            if (in.is_open()) {
                std::wstring line;
                while (std::getline(in, line)) {
                    // trim
                    auto l = line.find_first_not_of(L" \t\r\n");
                    if (l == std::wstring::npos) continue;
                    auto r = line.find_last_not_of(L" \t\r\n");
                    std::wstring s = line.substr(l, r - l + 1);
                    if (s.empty()) continue;
                    if (s[0] == L'!' || s[0] == L'#') continue; // comments
                    // very simple heuristic: if contains only [a-z0-9.-] treat as host
                    bool hostLike = true;
                    for (wchar_t c : s) {
                        if (!(iswalnum(c) || c == L'.' || c == L'-')) { hostLike = false; break; }
                    }
                    if (hostLike) {
                        // lower-case
                        std::transform(s.begin(), s.end(), s.begin(), towlower);
                        g_adblockHostFilters.insert(s);
                    } else {
                        g_adblockSubstringFilters.push_back(s);
                    }
                }
                in.close();
            }
        }
    }

    // Debug output
    wchar_t dbg[128];
    swprintf_s(dbg, L"AdBlock filters loaded: hosts=%zu substrings=%zu\n", g_adblockHostFilters.size(), g_adblockSubstringFilters.size());
    OutputDebugStringW(dbg);
    if (g_hwndStatusBar) {
        wchar_t status[128];
        swprintf_s(status, L"Ad-block: %zu hosts, %zu rules", g_adblockHostFilters.size(), g_adblockSubstringFilters.size());
        SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)status);
    }
}

// Download and aggregate common filter lists (EasyList, EasyPrivacy) into adblock_filters.txt
// Returns true on success, false on failure or user cancel.
bool DownloadAndAggregateFilters(HWND hwnd) {
    // Ask user for consent (lists are copyrighted by their authors)
    const wchar_t* msg = L"This will download publicly-available ad/filter lists (EasyList, EasyPrivacy) and aggregate them into a local filter file. These lists are maintained by third parties and have their own licenses. Continue?";
    int resp = MessageBoxW(hwnd, msg, L"Download filter lists?", MB_YESNO | MB_ICONQUESTION);
    if (resp != IDYES) return false;

    // URLs to download - can be modified if you want other lists
    std::vector<std::wstring> urls = {
        L"https://easylist.to/easylist/easylist.txt",
        L"https://easylist.to/easylist/easyprivacy.txt"
    };

    // Prepare paths
    wchar_t modulePath[MAX_PATH] = {0};
    if (GetModuleFileNameW(NULL, modulePath, ARRAYSIZE(modulePath)) == 0) return false;
    PathRemoveFileSpecW(modulePath);
    wchar_t outPath[MAX_PATH];
    PathCombineW(outPath, modulePath, L"adblock_filters.txt");

    // Write header with attribution
    {
        std::wofstream out(outPath, std::ios::out | std::ios::trunc);
        if (!out.is_open()) return false;
        out << L"! Aggregated filter list\n";
        out << L"! Aggregated from: EasyList, EasyPrivacy\n";
        out << L"! Modified on 23 November 2025\n";
        out << L"! Lines starting with '!' or '#' are comments and ignored.\n\n";
        out.close();
    }

    // Temporary download file
    wchar_t tempPath[MAX_PATH];
    if (GetTempPathW(MAX_PATH, tempPath) == 0) return false;
    wchar_t tempFile[MAX_PATH];

    for (const auto& u : urls) {
        // create temp filename
        if (GetTempFileNameW(tempPath, L"abk", 0, tempFile) == 0) continue;
        HRESULT hr = URLDownloadToFileW(NULL, u.c_str(), tempFile, 0, NULL);
        if (SUCCEEDED(hr)) {
            // Append non-comment lines to outPath
            std::wifstream in(tempFile);
            std::wofstream out(outPath, std::ios::out | std::ios::app);
            if (in.is_open() && out.is_open()) {
                std::wstring line;
                while (std::getline(in, line)) {
                    // trim whitespace
                    size_t l = line.find_first_not_of(L" \t\r\n");
                    if (l == std::wstring::npos) continue;
                    size_t r = line.find_last_not_of(L" \t\r\n");
                    std::wstring s = line.substr(l, r - l + 1);
                    if (s.empty()) continue;
                    if (s[0] == L'!' || s[0] == L'#') continue;
                    out << s << L"\n";
                }
                in.close(); out.close();
            }
        }
        // remove temp file
        DeleteFileW(tempFile);
    }

    return true;
}

// --- 5. WebView2 Initialization and Handlers ---

void ApplySettingsToWebView() {
    if (!g_webView) return;

    ComPtr<ICoreWebView2Settings> settings;
    if (SUCCEEDED(g_webView->get_Settings(&settings))) {
        
        // --- Core Settings (Script/Host) ---
        settings->put_IsScriptEnabled(g_isScriptEnabled ? TRUE : FALSE); 
        settings->put_AreDefaultScriptDialogsEnabled(g_areDefaultScriptDialogsEnabled ? TRUE : FALSE);         
        settings->put_AreHostObjectsAllowed(FALSE);         

        // --- Settings2 (User Agent) ---
        ComPtr<ICoreWebView2Settings2> settings2;
        if (SUCCEEDED(settings.As(&settings2))) {
            if (g_customUserAgentEnabled) {
                settings2->put_UserAgent(g_customUserAgentString.c_str());
            } else {
                settings2->put_UserAgent(L"");
            }
        }

        // NOTE: Setting tracking-prevention on the environment requires using
        // the environment options when creating the WebView2 environment.
        // That logic is non-trivial and depends on the WebView2 SDK version.
        // The previous malformed attempt has been removed. Tracking prevention
        // state (g_enableTrackingPrevention) is still stored and can be applied
        // when the environment is created with proper ICoreWebView2EnvironmentOptions
        // support.

       // --- Settings3 (Third-Party Cookies Blocking) ---
       ComPtr<ICoreWebView2Settings3> settings3;
       if (SUCCEEDED(settings.As(&settings3))) {
           // The concrete way to control third-party cookie behavior may vary by
           // WebView2 runtime version. For now we rely on environment flags
           // (--enable-features=ThirdPartyStoragePartitioning,PartitionedCookies)
           // which are set when the environment is created above. Inform the
           // user that third-party cookie handling is being managed by runtime
           // flags passed to the environment.
           SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Third-party cookies: controlled via environment flags.");
       } else {
           SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Third-party cookie control not available in this WebView build.");
       }
        
        // --- Settings4 (Autofill/Password Security) ---
        ComPtr<ICoreWebView2Settings4> settings4;
        if (SUCCEEDED(settings.As(&settings4))) {
            settings4->put_IsPasswordAutosaveEnabled(g_isPasswordAutosaveEnabled ? TRUE : FALSE); 
            settings4->put_IsGeneralAutofillEnabled(g_isGeneralAutofillEnabled ? TRUE : FALSE);  
        }
    }
}


void InitializeWebView2(HWND hwnd) {
    // Try to create concrete environment-options if the SDK header is present
    // (WebView2EnvironmentOptions.h). This lets us enable tracking prevention
    // at environment creation time when supported. If the header/class isn't
    // available, fall back to nullptr options for maximum compatibility.
    ComPtr<ICoreWebView2EnvironmentOptions> envOptions;
#if defined(HAVE_WEBVIEW2_ENV_OPTIONS)
    // Instantiate the provided CoreWebView2EnvironmentOptions runtime class
    // (this type is only available in newer WebView2 SDK headers).
    {
        ComPtr<CoreWebView2EnvironmentOptions> concreteOptions = Microsoft::WRL::Make<CoreWebView2EnvironmentOptions>();
        if (concreteOptions) {
            // If the environment-options interface supports the tracking prevention
            // property (ICoreWebView2EnvironmentOptions5), set it according to
            // the user's saved preference.
            ComPtr<ICoreWebView2EnvironmentOptions5> envOptions5;
            if (SUCCEEDED(concreteOptions.As(&envOptions5))) {
                envOptions5->put_EnableTrackingPrevention(g_enableTrackingPrevention ? TRUE : FALSE);
            }
            // Do not rely on shipping/extensions for ad-blocking. Use the local
            // aggregated filter lists instead. Disable browser extensions to avoid
            // any dependency on an unpacked extension.
            concreteOptions->put_AreBrowserExtensionsEnabled(FALSE);
            // Always enable privacy-related Chromium flags for partitioning and
            // a robust third-party cookie fallback.
            std::wstring featureArgs = L"--enable-features=ThirdPartyStoragePartitioning,PartitionedCookies --disable-third-party-cookies";
            concreteOptions->put_AdditionalBrowserArguments(featureArgs.c_str());
            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Privacy features enabled via flags; using local filter lists (no extension).");
            OutputDebugStringW((L"WebView2 AdditionalBrowserArguments: " + featureArgs + L"\n").c_str());
            // Use the concrete options as the ICoreWebView2EnvironmentOptions pointer
            concreteOptions.As(&envOptions);
        }
    }
#endif

    CreateCoreWebView2EnvironmentWithOptions(nullptr, nullptr, envOptions.Get(),
        Callback<ICoreWebView2CreateCoreWebView2EnvironmentCompletedHandler>(
            [hwnd](HRESULT result, ICoreWebView2Environment* env) -> HRESULT {
                if (FAILED(result) || env == nullptr) {
                    wchar_t buf[256];
                    swprintf_s(buf, 256, L"Failed to create WebView2 environment (HRESULT=0x%08X). Ensure WebView2 Runtime is installed.", (unsigned)result);
                    MessageBoxW(hwnd, buf, L"WebView2 Error", MB_OK | MB_ICONERROR);
                    return S_OK;
                }

                env->CreateCoreWebView2Controller(hwnd,
                    Callback<ICoreWebView2CreateCoreWebView2ControllerCompletedHandler>(
                        [env, hwnd](HRESULT result, ICoreWebView2Controller* controller) -> HRESULT {
                            if (controller != nullptr) {
                                g_controller = controller;
                                g_controller->get_CoreWebView2(&g_webView);
                                
                                EventRegistrationToken token;
                                
                                ApplySettingsToWebView();

                                // Source Changed Handler (Updates URL Bar and global URL)
                                g_webView->add_SourceChanged(Callback<ICoreWebView2SourceChangedEventHandler>(
                                    [](ICoreWebView2* webview, ICoreWebView2SourceChangedEventArgs* args) -> HRESULT {
                                        LPWSTR uri;
                                        webview->get_Source(&uri);
                                        if (uri != nullptr) {
                                            SetWindowText(g_hwndUrlBar, uri);
                                            g_currentUrl = uri; 
                                            CoTaskMemFree(uri);
                                        }
                                        return S_OK;
                                    }).Get(), &token);

                                // Title Changed Handler (Updates Main Window Title)
                                g_webView->add_DocumentTitleChanged(Callback<ICoreWebView2DocumentTitleChangedEventHandler>(
                                    [](ICoreWebView2* webview, IUnknown* args) -> HRESULT {
                                        LPWSTR title;
                                        webview->get_DocumentTitle(&title);
                                        if (title != nullptr) {
                                            wchar_t windowTitle[256];
                                            swprintf_s(windowTitle, 256, L"%ls - FlameDarkness Browser Beta 0.91", title);
                                            SetWindowText(g_hwndMain, windowTitle);
                                            g_currentTitle = title; 
                                            CoTaskMemFree(title);
                                        }
                                        return S_OK;
                                    }).Get(), &token);

                                // Navigation Complete Handler (Updates Status Bar)
                                g_webView->add_NavigationCompleted(Callback<ICoreWebView2NavigationCompletedEventHandler>(
                                    [](ICoreWebView2* webview, ICoreWebView2NavigationCompletedEventArgs* args) -> HRESULT {
                                        BOOL success;
                                        args->get_IsSuccess(&success);
                                        
                                        if (success) {
                                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Done");
                                            // After navigation completes, proactively remove third-party
                                            // cookies to improve privacy. We do this by enumerating all
                                            // cookies in the current profile and deleting those whose
                                            // domain does not match the top-level host.
                                            // This uses the CookieManager available via ICoreWebView2_2.
                                            // If the API isn't available this is a no-op.
                                            wchar_t mainUrlBuf[2048] = {0};
                                            if (g_currentUrl.size() > 0) {
                                                wcsncpy_s(mainUrlBuf, g_currentUrl.c_str(), _TRUNCATE);
                                            } else {
                                                LPWSTR src = nullptr;
                                                if (SUCCEEDED(webview->get_Source(&src)) && src) {
                                                    wcsncpy_s(mainUrlBuf, src, _TRUNCATE);
                                                    CoTaskMemFree(src);
                                                }
                                            }
                                            // Extract host from main URL
                                            std::wstring mainHost;
                                            auto GetHostFromUrl = [](const std::wstring& url) -> std::wstring {
                                                if (url.empty()) return L"";
                                                size_t p = url.find(L"://");
                                                size_t start = 0;
                                                if (p != std::wstring::npos) start = p + 3;
                                                size_t slash = url.find(L'/', start);
                                                std::wstring host = (slash == std::wstring::npos) ? url.substr(start) : url.substr(start, slash - start);
                                                // Strip potential credentials and port
                                                size_t at = host.rfind(L'@');
                                                if (at != std::wstring::npos) host = host.substr(at + 1);
                                                size_t colon = host.find(L':');
                                                if (colon != std::wstring::npos) host = host.substr(0, colon);
                                                // Lowercase for comparison
                                                std::transform(host.begin(), host.end(), host.begin(), towlower);
                                                return host;
                                            };
                                            mainHost = GetHostFromUrl(mainUrlBuf);

                                            if (!mainHost.empty()) {
                                                ComPtr<ICoreWebView2_2> webview2;
                                                if (SUCCEEDED(g_webView.As(&webview2))) {
                                                    ComPtr<ICoreWebView2CookieManager> cookieManager;
                                                    if (SUCCEEDED(webview2->get_CookieManager(&cookieManager)) && cookieManager) {
                                                        // Request all cookies in the profile (empty uri -> all cookies)
                                                        ComPtr<ICoreWebView2CookieManager> cmCopy = cookieManager;
                                                        std::wstring hostCopy = mainHost;
                                                        cmCopy->GetCookies(nullptr, Callback<ICoreWebView2GetCookiesCompletedHandler>(
                                                            [cmCopy, hostCopy](HRESULT hr, ICoreWebView2CookieList* cookieList) -> HRESULT {
                                                                if (FAILED(hr) || !cookieList) return S_OK;
                                                                UINT32 count = 0;
                                                                if (FAILED(cookieList->get_Count(&count))) return S_OK;
                                                                UINT32 removed = 0;
                                                                for (UINT32 i = 0; i < count; ++i) {
                                                                    ComPtr<ICoreWebView2Cookie> cookie;
                                                                    if (SUCCEEDED(cookieList->GetValueAtIndex(i, &cookie)) && cookie) {
                                                                        LPWSTR domainW = nullptr;
                                                                        if (SUCCEEDED(cookie->get_Domain(&domainW)) && domainW) {
                                                                            std::wstring domain(domainW);
                                                                            CoTaskMemFree(domainW);
                                                                            // Normalize
                                                                            if (!domain.empty() && domain[0] == L'.') domain = domain.substr(1);
                                                                            std::transform(domain.begin(), domain.end(), domain.begin(), towlower);

                                                                            bool isSame = false;
                                                                            if (domain == hostCopy) isSame = true;
                                                                            else if (domain.size() > hostCopy.size()) {
                                                                                // e.g. cookie domain 'sub.example.com' vs host 'example.com'
                                                                                size_t pos = domain.rfind(L"." + hostCopy);
                                                                                if (pos != std::wstring::npos && pos + 1 + hostCopy.size() == domain.size()) isSame = true;
                                                                            }

                                                                            if (!isSame) {
                                                                                // Delete this cookie (third-party)
                                                                                cmCopy->DeleteCookie(cookie.Get());
                                                                                ++removed;
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                                // Report to status bar via debug output (UI thread may be different)
                                                                if (removed > 0) {
                                                                    wchar_t buf[128];
                                                                    swprintf_s(buf, L"Removed %u third-party cookies", removed);
                                                                    OutputDebugStringW(buf);
                                                                }
                                                                return S_OK;
                                                            }).Get());
                                                    }
                                                }
                                            }
                                        } else {
                                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Navigation failed");
                                        }
                                        return S_OK;
                                    }).Get(), &token);

                                    // Navigation Starting Handler (Force HTTPS upgrade)
                                    g_webView->add_NavigationStarting(Callback<ICoreWebView2NavigationStartingEventHandler>(
                                        [](ICoreWebView2* webview, ICoreWebView2NavigationStartingEventArgs* args) -> HRESULT {
                                            LPWSTR uri = nullptr;
                                            if (SUCCEEDED(args->get_Uri(&uri)) && uri) {
                                                std::wstring s(uri);
                                                CoTaskMemFree(uri);
                                                if (g_forceHTTPS) {
                                                    // If navigation is explicitly http://, upgrade to https
                                                    if (s.rfind(L"http://", 0) == 0) {
                                                        args->put_Cancel(TRUE);
                                                        std::wstring secure = L"https://" + s.substr(7);
                                                        if (g_webView) g_webView->Navigate(secure.c_str());
                                                    }
                                                }
                                            }
                                            return S_OK;
                                        }).Get(), &token);
                                
                                // Pop-up Blocker
                                g_webView->add_NewWindowRequested(Callback<ICoreWebView2NewWindowRequestedEventHandler>(
                                    [](ICoreWebView2* webview, ICoreWebView2NewWindowRequestedEventArgs* args) -> HRESULT {
                                        if (g_blockPopups) {
                                            args->put_Handled(TRUE);
                                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Pop-up window blocked.");
                                        } 
                                        return S_OK;
                                    }).Get(), &token);

								
								// NEW: Permission Handler
								g_webView->add_PermissionRequested(Callback<ICoreWebView2PermissionRequestedEventHandler>(
									[](ICoreWebView2* webview, ICoreWebView2PermissionRequestedEventArgs* args) -> HRESULT {
										COREWEBVIEW2_PERMISSION_KIND kind;
										args->get_PermissionKind(&kind);

										bool do_block = false;
										LPCWSTR message = L"";

										switch (kind) {
											case COREWEBVIEW2_PERMISSION_KIND_NOTIFICATIONS:
												if (g_blockNotifications) {
													do_block = true;
													message = L"Notification permission blocked.";
												}
												break;
                                            case COREWEBVIEW2_PERMISSION_KIND_GEOLOCATION:
                                                if (g_blockLocation) {
                                                    do_block = true;
                                                    message = L"Location permission blocked.";
                                                }
                                                break;
											case COREWEBVIEW2_PERMISSION_KIND_MICROPHONE:
												if (g_blockMicrophone) {
													do_block = true;
													message = L"Microphone permission blocked.";
												}
												break;
											default:
												// For other permissions, use default behavior.
												args->put_State(COREWEBVIEW2_PERMISSION_STATE_DEFAULT);
												return S_OK;
										}

										if (do_block) {
											args->put_State(COREWEBVIEW2_PERMISSION_STATE_DENY);
											SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)message);
										} else {
											// You might want to prompt the user here instead of always allowing
											args->put_State(COREWEBVIEW2_PERMISSION_STATE_ALLOW);
										}
										
										return S_OK;
									}).Get(), &token);
                                
                               // Default start page is a privacy-focused and compatible search engine.
                                HRESULT hrFilter = g_webView->AddWebResourceRequestedFilter(L"*", COREWEBVIEW2_WEB_RESOURCE_CONTEXT_ALL);
                                (void)hrFilter; // ignore if not supported

                                EventRegistrationToken token2;
                                g_webView->add_WebResourceRequested(Callback<ICoreWebView2WebResourceRequestedEventHandler>(
                                    [env](ICoreWebView2* webview, ICoreWebView2WebResourceRequestedEventArgs* args) -> HRESULT {
                                        if (!args) return S_OK;
                                        ComPtr<ICoreWebView2WebResourceRequest> request;
                                        if (FAILED(args->get_Request(&request)) || !request) return S_OK;

                                        // If user enabled Do-Not-Track, add DNT request header
                                        ComPtr<ICoreWebView2HttpRequestHeaders> headers;
                                        if (g_trackingPrevention && SUCCEEDED(request->get_Headers(&headers)) && headers) {
                                            headers->SetHeader(L"DNT", L"1");
                                        }

                                        LPWSTR uriW = nullptr;
                                        request->get_Uri(&uriW);
                                        if (!uriW) return S_OK;
                                        std::wstring uri(uriW);
                                        CoTaskMemFree(uriW);

                                        // Use ad-block filters if enabled
                                        if (g_adBlockEnabled) {
                                            // Extract host from URI
                                            auto GetHost = [](const std::wstring& url) -> std::wstring {
                                                if (url.empty()) return L"";
                                                size_t p = url.find(L"://");
                                                size_t start = (p == std::wstring::npos) ? 0 : (p + 3);
                                                size_t slash = url.find(L'/', start);
                                                std::wstring h = (slash == std::wstring::npos) ? url.substr(start) : url.substr(start, slash - start);
                                                // strip credentials
                                                size_t at = h.rfind(L'@'); if (at != std::wstring::npos) h = h.substr(at + 1);
                                                // strip port
                                                size_t colon = h.find(L':'); if (colon != std::wstring::npos) h = h.substr(0, colon);
                                                std::transform(h.begin(), h.end(), h.begin(), towlower);
                                                return h;
                                            };

                                            std::wstring host = GetHost(uri);

                                            bool blocked = false;

                                            if (!host.empty()) {
                                                // Exact or suffix host match
                                                for (const auto& fh : g_adblockHostFilters) {
                                                    if (host == fh) { blocked = true; break; }
                                                    if (host.size() > fh.size() && host.compare(host.size() - fh.size(), fh.size(), fh) == 0) {
                                                        // e.g. host 'sub.example.com' ends with 'example.com'
                                                        if (host[host.size() - fh.size() - 1] == L'.') { blocked = true; break; }
                                                    }
                                                }
                                            }

                                            // Substring-based filters
                                            if (!blocked) {
                                                for (const auto& pat : g_adblockSubstringFilters) {
                                                    if (uri.find(pat) != std::wstring::npos) { blocked = true; break; }
                                                }
                                            }

                                            if (blocked) {
                                                IStream* emptyStream = SHCreateMemStream(nullptr, 0);
                                                if (env && emptyStream) {
                                                    ComPtr<ICoreWebView2WebResourceResponse> response;
                                                    HRESULT hr = env->CreateWebResourceResponse(emptyStream, 204, L"No Content", L"Content-Type: text/plain", &response);
                                                    if (SUCCEEDED(hr) && response) {
                                                        args->put_Response(response.Get());
                                                        SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Blocked resource by ad-block filter");
                                                    }
                                                    emptyStream->Release();
                                                }
                                            }
                                        }
                                        return S_OK;
                                    }).Get(), &token2);

                                g_webView->Navigate(L"https://duckduckgo.com");
                                ResizeWebView();
                                g_controller->put_IsVisible(TRUE);
                            }
                            return S_OK;
                        }).Get());
                return S_OK;
            }).Get());
}


// --- 6. Settings Application, Creation, and Procedures ---

LRESULT CALLBACK SettingsWindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {
    switch (uMsg) {
        case WM_CLOSE: {
            SaveFileSettings(); 
            ShowWindow(hwnd, SW_HIDE);
            return 0;
        }
            
        case WM_COMMAND: {
            if (HIWORD(wParam) == BN_CLICKED) {
                HWND hCheckbox = (HWND)lParam;
                int controlId = LOWORD(wParam);
                bool isChecked = SendMessage(hCheckbox, BM_GETCHECK, 0, 0) == BST_CHECKED;

                if (controlId == IDC_CHECK_BLOCK_POPUPS) {
                    g_blockPopups = isChecked;
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockPopups ? L"Pop-up blocking ON" : L"Pop-up blocking OFF"));
                }
                else if (controlId == IDC_CHECK_DNT) {
                            g_trackingPrevention = isChecked;
                            // DNT is a best-effort header; mark as optional in the status
                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_trackingPrevention ? L"DNT header: ON (best-effort)" : L"DNT header: OFF"));
                }
                else if (controlId == IDC_CHECK_CUSTOM_UA) {
                    g_customUserAgentEnabled = isChecked;
                    EnableWindow(GetDlgItem(hwnd, IDC_UA_EDIT_BOX), g_customUserAgentEnabled);
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_customUserAgentEnabled ? L"Custom User Agent ON" : L"Custom User Agent OFF"));
                }
                else if (controlId == IDC_CHECK_TRACKING_PREVENTION) { 
                    g_enableTrackingPrevention = isChecked;
                    // Environment-level tracking prevention is work-in-progress depending on WebView2 runtime
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_enableTrackingPrevention ? L"Tracking Prevention: ON (work-in-progress)" : L"Tracking Prevention: OFF"));
                }
                else if (controlId == IDC_CHECK_FORCE_HTTPS) {
                    g_forceHTTPS = isChecked;
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_forceHTTPS ? L"Force HTTPS ON" : L"Force HTTPS OFF"));
                }
                else if (controlId == IDC_CHECK_SCRIPT_ENABLED) {
                    g_isScriptEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_isScriptEnabled ? L"JavaScript ON" : L"JavaScript OFF (High Security)"));
                }
                else if (controlId == IDC_CHECK_SCRIPT_DIALOGS) {
                    g_areDefaultScriptDialogsEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_areDefaultScriptDialogsEnabled ? L"Script Dialogs ON" : L"Script Dialogs OFF (Recommended)"));
                }
                else if (controlId == IDC_CHECK_PASSWORD_SAVE) {
                    g_isPasswordAutosaveEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_isPasswordAutosaveEnabled ? L"Password Save ON" : L"Password Save OFF (Recommended)"));
                }
                else if (controlId == IDC_CHECK_AUTOFILL) {
                    g_isGeneralAutofillEnabled = isChecked;
                    ApplySettingsToWebView();
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_isGeneralAutofillEnabled ? L"General Autofill ON" : L"General Autofill OFF (Recommended)"));
                }
				
				// NEW PERMISSION HANDLERS
				else if (controlId == IDC_CHECK_BLOCK_NOTIFICATIONS) {
					g_blockNotifications = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockNotifications ? L"Notifications Blocked" : L"Notifications Allowed"));
				}
				else if (controlId == IDC_CHECK_BLOCK_LOCATION) {
					g_blockLocation = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockLocation ? L"Location Access Blocked" : L"Location Access Allowed"));
				}
				else if (controlId == IDC_CHECK_BLOCK_WEBCAM) {
					g_blockWebcam = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockWebcam ? L"Webcam Access Blocked" : L"Webcam Access Allowed"));
				}
				else if (controlId == IDC_CHECK_BLOCK_MICROPHONE) {
					g_blockMicrophone = isChecked;
					SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_blockMicrophone ? L"Microphone Access Blocked" : L"Microphone Access Allowed"));
				}
				
            } else if (HIWORD(wParam) == EN_CHANGE) {
                if (LOWORD(wParam) == IDC_UA_EDIT_BOX) {
                    wchar_t buffer[1024];
                    GetWindowTextW(GetDlgItem(hwnd, IDC_UA_EDIT_BOX), buffer, 1024);
                    g_customUserAgentString = buffer;
                    
                    if (g_customUserAgentEnabled) {
                        ApplySettingsToWebView();
                        SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"User Agent updated.");
                    }
                }
            }
            return 0;
        }
    }
    return DefWindowProc(hwnd, uMsg, wParam, lParam);
}

void ShowSettingsWindow(HWND hParent) {
    HINSTANCE hInst = (HINSTANCE)GetWindowLongPtr(hParent, GWLP_HINSTANCE);
    const wchar_t SETTINGS_CLASS_NAME[] = L"BrowserSettingsWindow";
    
    // Register the Settings Window Class once
    WNDCLASSW wc = { 
        0, SettingsWindowProc, 0, 0, hInst, LoadIcon(NULL, IDI_APPLICATION), 
        LoadCursor(NULL, IDC_ARROW), (HBRUSH)(COLOR_WINDOW + 1), nullptr, SETTINGS_CLASS_NAME
    };
    if (!GetClassInfoW(hInst, SETTINGS_CLASS_NAME, &wc)) RegisterClassW(&wc);

    if (!g_hwndSettings) {
        g_hwndSettings = CreateWindowExW(
            0, SETTINGS_CLASS_NAME, L"Settings - Security & Privacy", 
            WS_OVERLAPPEDWINDOW | WS_CAPTION | WS_SYSMENU | WS_MINIMIZEBOX,
            CW_USEDEFAULT, CW_USEDEFAULT, 450, 720, // Increased window height so all privacy controls are visible
            hParent, nullptr, hInst, nullptr
        );
        if (!g_hwndSettings) return;

        int y = PADDING * 3;

        // --- 1. General Header ---
        CreateWindow(L"STATIC", L"Security and Privacy Features", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_SETTINGS_HEADER, hInst, nullptr);
        y += 30;
        CreateWindow(L"STATIC", L"", WS_CHILD | WS_VISIBLE | SS_ETCHEDHORZ, 20, y, 400, 1, g_hwndSettings, nullptr, hInst, nullptr);
        y += PADDING * 3;

        // --- 2. Checkboxes ---
        
        // Pop-ups
        CreateWindow(L"BUTTON", L"Block pop-up windows (Recommended)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_POPUPS, hInst, nullptr);
        y += 30;

        // DNT
        CreateWindow(L"BUTTON", L"Send 'Do Not Track' (DNT) header", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_DNT, hInst, nullptr);
        y += 30;

        // Force HTTPS option (moved up so it's closer to DNT)
        CreateWindow(L"BUTTON", L"Force HTTPS (upgrade insecure requests)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_FORCE_HTTPS, hInst, nullptr);
        y += 30;

        // Tracking Prevention Button
        CreateWindow(L"BUTTON", L"Enable Tracking Prevention", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_TRACKING_PREVENTION, hInst, nullptr);
        y += 40; 
        
        // --- 3. Script Control Settings (NEW) ---
        CreateWindow(L"STATIC", L"Script and User Input Control", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_UA_LABEL, hInst, nullptr);
        y += 20;

        // NEW: Script Enabled
        CreateWindow(L"BUTTON", L"Enable JavaScript", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_SCRIPT_ENABLED, hInst, nullptr);
        y += 30;

        // NEW: Script Dialogs Enabled
        CreateWindow(L"BUTTON", L"Allow JavaScript Dialogs (Alert, Confirm, Prompt)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_SCRIPT_DIALOGS, hInst, nullptr);
        y += 30;

        // NEW: Password Autosave Enabled
        CreateWindow(L"BUTTON", L"Allow Password Autosave", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_PASSWORD_SAVE, hInst, nullptr);
        y += 30;

        // NEW: General Autofill Enabled
        CreateWindow(L"BUTTON", L"Allow General Autofill (Address, Credit Card)", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_AUTOFILL, hInst, nullptr);
        y += 40;

		
		// --- NEW: Permissions Section ---
        CreateWindow(L"STATIC", L"Permission Control", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, nullptr, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Notifications", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_NOTIFICATIONS, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Location Access", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_LOCATION, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Webcam Access", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_WEBCAM, hInst, nullptr);
        y += 30;

        CreateWindow(L"BUTTON", L"Block Microphone Access", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_BLOCK_MICROPHONE, hInst, nullptr);
        y += 40;

        y += 10;
		

        // --- 4. User Agent Section ---
        CreateWindow(L"STATIC", L"Custom Browser Identity (User Agent)", WS_CHILD | WS_VISIBLE | SS_LEFT, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_UA_LABEL, hInst, nullptr);
        y += 20;

        // Checkbox: Custom User Agent Enable
        CreateWindow(L"BUTTON", L"Override User Agent String", WS_CHILD | WS_VISIBLE | BS_AUTOCHECKBOX, 
            20, y, 400, 20, g_hwndSettings, (HMENU)IDC_CHECK_CUSTOM_UA, hInst, nullptr);
        y += 30;

        // Edit Box: User Agent String
        CreateWindowEx(WS_EX_CLIENTEDGE, L"EDIT", g_customUserAgentString.c_str(),
            WS_CHILD | WS_VISIBLE | ES_LEFT | ES_AUTOHSCROLL, 20, y, 400, 24, g_hwndSettings, (HMENU)IDC_UA_EDIT_BOX, hInst, nullptr);
        y += 40; 

        // Apply font
        HFONT hFont = (HFONT)GetStockObject(SYSTEM_FONT);
        EnumChildWindows(g_hwndSettings, [](HWND hwndChild, LPARAM lParam) -> BOOL {
            SendMessage(hwndChild, WM_SETFONT, (WPARAM)lParam, TRUE);
            return TRUE;
        }, (LPARAM)hFont);
    }
    
    // Set toggle and permission states
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_POPUPS), BM_SETCHECK, g_blockPopups ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_DNT), BM_SETCHECK, g_trackingPrevention ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_CUSTOM_UA), BM_SETCHECK, g_customUserAgentEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_TRACKING_PREVENTION), BM_SETCHECK, g_enableTrackingPrevention ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_SCRIPT_ENABLED), BM_SETCHECK, g_isScriptEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_SCRIPT_DIALOGS), BM_SETCHECK, g_areDefaultScriptDialogsEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_PASSWORD_SAVE), BM_SETCHECK, g_isPasswordAutosaveEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_AUTOFILL), BM_SETCHECK, g_isGeneralAutofillEnabled ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_NOTIFICATIONS), BM_SETCHECK, g_blockNotifications ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_LOCATION), BM_SETCHECK, g_blockLocation ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_WEBCAM), BM_SETCHECK, g_blockWebcam ? BST_CHECKED : BST_UNCHECKED, 0);
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_BLOCK_MICROPHONE), BM_SETCHECK, g_blockMicrophone ? BST_CHECKED : BST_UNCHECKED, 0);

    // Set Force HTTPS checkbox state
    SendMessage(GetDlgItem(g_hwndSettings, IDC_CHECK_FORCE_HTTPS), BM_SETCHECK, g_forceHTTPS ? BST_CHECKED : BST_UNCHECKED, 0);
	

    SetWindowTextW(GetDlgItem(g_hwndSettings, IDC_UA_EDIT_BOX), g_customUserAgentString.c_str());
    EnableWindow(GetDlgItem(g_hwndSettings, IDC_UA_EDIT_BOX), g_customUserAgentEnabled);

    ShowWindow(g_hwndSettings, SW_SHOW);
    SetForegroundWindow(g_hwndSettings);
}


// --- 7. Disabled Features ---

void ShowHistoryWindow(HWND hParent) {
    MessageBox(hParent, L"History logging is disabled for security and privacy reasons.", L"Feature Disabled", MB_OK | MB_ICONINFORMATION);
}


// --- 8. Main Window Creation and Procedures ---

void NavigateToUrl(const wchar_t* url) {
    wstring s_url(url);
    // Default to HTTPS.
    if (s_url.find(L"://") == wstring::npos) {
        s_url = L"https://" + s_url;
    }
    if (g_webView) {
        g_webView->Navigate(s_url.c_str());
        SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Loading...");
    }
}

void CreateBrowserControls(HWND hwnd) {
    HINSTANCE hInst = (HINSTANCE)GetWindowLongPtr(hwnd, GWLP_HINSTANCE);
    
    // Create Toolbar buttons
    int x = PADDING;
    g_hwndBackButton = CreateWindow(L"BUTTON", L"<", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_BACK_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;
    g_hwndForwardButton = CreateWindow(L"BUTTON", L">", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_FORWARD_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;
    g_hwndRefreshButton = CreateWindow(L"BUTTON", L"Refresh", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_REFRESH_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;
    g_hwndHomeButton = CreateWindow(L"BUTTON", L"Home", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_HOME_BUTTON, hInst, 0);
    x += BUTTON_WIDTH + PADDING;

    // Create URL Bar (Edit Control)
    g_hwndUrlBar = CreateWindowEx(WS_EX_CLIENTEDGE, L"EDIT", L"https://duckduckgo.com", 
                                  WS_CHILD | WS_VISIBLE | ES_LEFT | ES_AUTOHSCROLL, 
                                  x, PADDING, 1, BUTTON_HEIGHT, hwnd, (HMENU)IDC_URL_BAR, hInst, 0);

    // Create GO Button
    g_hwndGoButton = CreateWindow(L"BUTTON", L"Go", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, x, PADDING, GO_BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_GO_BUTTON, hInst, 0);

    // Create Feature Buttons
    int right_x = GetSystemMetrics(SM_CXSCREEN); 
    g_hwndSettingsButton = CreateWindow(L"BUTTON", L"Settings", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80, PADDING, 80, BUTTON_HEIGHT, hwnd, (HMENU)IDC_SETTINGS_BUTTON, hInst, 0);
    g_hwndFavoritesButton = CreateWindow(L"BUTTON", L"Ad Blocker", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80 * 2 - PADDING, PADDING, 80, BUTTON_HEIGHT, hwnd, (HMENU)IDC_ADBLOCKER_BUTTON, hInst, 0);
    g_hwndHistoryButton = CreateWindow(L"BUTTON", L"History", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80 * 3 - PADDING * 2, PADDING, 80, BUTTON_HEIGHT, hwnd, (HMENU)IDC_HISTORY_BUTTON, hInst, 0);
    g_hwndHelpButton = CreateWindow(L"BUTTON", L"Help", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80 * 4 - PADDING * 3, PADDING, 80, BUTTON_HEIGHT, hwnd, (HMENU)IDC_HELP_BUTTON, hInst, 0);
    // Make Privacy Test button wider so the label fits
    g_hwndPrivacyButton = CreateWindow(L"BUTTON", L"Privacy Test", WS_TABSTOP | WS_VISIBLE | WS_CHILD | BS_PUSHBUTTON, right_x - 80 * 4 - PRIVACY_BUTTON_WIDTH - PADDING * 4, PADDING, PRIVACY_BUTTON_WIDTH, BUTTON_HEIGHT, hwnd, (HMENU)IDC_PRIVACY_TEST_BUTTON, hInst, 0);


    // Create Status Bar
    g_hwndStatusBar = CreateWindowEx(0, STATUSCLASSNAME, nullptr, 
                                     WS_CHILD | WS_VISIBLE | SBARS_SIZEGRIP, 
                                     0, 0, 0, 0, hwnd, nullptr, hInst, nullptr);
    int parts[STATUS_PARTS] = {100, 250, -1};
    SendMessage(g_hwndStatusBar, SB_SETPARTS, STATUS_PARTS, (LPARAM)parts);
    SendMessage(g_hwndStatusBar, SB_SETTEXT, 0, (LPARAM)L"Ready");
    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Security Status: OK");
    SendMessage(g_hwndStatusBar, SB_SETTEXT, 2, (LPARAM)L"FlameDarkness Browser");

    // Apply font to controls
    // Use SYSTEM_FONT which is generally better for Unicode/Emoji support
    HFONT hFont = (HFONT)GetStockObject(SYSTEM_FONT);
    EnumChildWindows(hwnd, [](HWND hwndChild, LPARAM lParam) -> BOOL {
        SendMessage(hwndChild, WM_SETFONT, (WPARAM)lParam, TRUE);
        return TRUE;
    }, (LPARAM)hFont);
}

void LayoutToolbarControls(HWND hwnd, int windowWidth) {
    // Calculate total fixed width for buttons (4 Nav buttons + 5 Feature buttons)
    const int navButtonWidth = BUTTON_WIDTH * 4;
    const int navButtonPadding = PADDING * 5; 
    // Adjusted to 4 buttons of 80px width plus a wider Privacy Test button
    const int featureButtonTotalWidth = 80 * 4 + PRIVACY_BUTTON_WIDTH + PADDING * 5; 

    const int urlBarStart = navButtonWidth + navButtonPadding;
    const int urlBarEnd = windowWidth - GO_BUTTON_WIDTH - PADDING - featureButtonTotalWidth;
    const int urlBarWidth = urlBarEnd - urlBarStart;

    // Reposition URL Bar and GO Button
    MoveWindow(g_hwndUrlBar, urlBarStart, PADDING, urlBarWidth, BUTTON_HEIGHT, TRUE);
    MoveWindow(g_hwndGoButton, urlBarStart + urlBarWidth + PADDING, PADDING, GO_BUTTON_WIDTH, BUTTON_HEIGHT, TRUE);

    // Reposition Feature Buttons (Fixed width 80px)
    int current_x = windowWidth - PADDING - 80;
    MoveWindow(g_hwndSettingsButton, current_x, PADDING, 80, BUTTON_HEIGHT, TRUE);
    
    current_x -= (80 + PADDING);
    MoveWindow(g_hwndFavoritesButton, current_x, PADDING, 80, BUTTON_HEIGHT, TRUE);

    current_x -= (80 + PADDING);
    MoveWindow(g_hwndHistoryButton, current_x, PADDING, 80, BUTTON_HEIGHT, TRUE);

    current_x -= (80 + PADDING);
    MoveWindow(g_hwndHelpButton, current_x, PADDING, 80, BUTTON_HEIGHT, TRUE);

    current_x -= (PRIVACY_BUTTON_WIDTH + PADDING);
    MoveWindow(g_hwndPrivacyButton, current_x, PADDING, PRIVACY_BUTTON_WIDTH, BUTTON_HEIGHT, TRUE);

}

void ResizeWebView() {
    if (g_controller) {
        RECT bounds;
        GetClientRect(g_hwndMain, &bounds);
        
        // Exclude Toolbar and Status Bar areas
        bounds.top += TOOLBAR_HEIGHT;
        bounds.bottom -= STATUSBAR_HEIGHT;
        
        g_controller->put_Bounds(bounds);
        
        // Move Status Bar to bottom
        MoveWindow(g_hwndStatusBar, 0, bounds.bottom, bounds.right, STATUSBAR_HEIGHT, TRUE);
    }
}


LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {
    switch (uMsg) {
        case WM_CREATE: {
            InitializeBrowserState();
            CreateBrowserControls(hwnd);
            InitializeWebView2(hwnd);
            break;
        }

        case WM_SIZE: {
            int width = LOWORD(lParam);
            LayoutToolbarControls(hwnd, width);
            ResizeWebView();
            break;
        }

        case WM_COMMAND: {
            int wmId = LOWORD(wParam);
            
            // Process button clicks
            switch (wmId) {
                case IDC_GO_BUTTON: {
                    wchar_t urlBuffer[2048];
                    GetWindowText(g_hwndUrlBar, urlBuffer, 2048);
                    NavigateToUrl(urlBuffer);
                    break;
                }
                case IDC_BACK_BUTTON:
                    if (g_webView) g_webView->GoBack();
                    break;
                case IDC_FORWARD_BUTTON:
                    if (g_webView) g_webView->GoForward();
                    break;
                case IDC_REFRESH_BUTTON:
                    if (g_webView) g_webView->Reload();
                    break;
                case IDC_HOME_BUTTON:
                    NavigateToUrl(L"https://duckduckgo.com");
                    break;
                case IDC_HISTORY_BUTTON:
                    ShowHistoryWindow(hwnd); 
                    break;
                case IDC_ADBLOCKER_BUTTON: {
                    // Show popup menu for Ad Blocker with Toggle / Reload / License
                    HMENU hMenu = CreatePopupMenu();
                    if (hMenu) {
                        // Informational (disabled) menu item to show list provenance
                        AppendMenuW(hMenu, MF_STRING | MF_DISABLED | MF_GRAYED, 0, L"Relying on EasyList and EasyPrivacy");
                        AppendMenuW(hMenu, MF_SEPARATOR, 0, nullptr);
                        std::wstring toggleLabel = g_adBlockEnabled ? L"Disable Ad Blocker" : L"Enable Ad Blocker";
                        AppendMenuW(hMenu, MF_STRING, IDM_ADBLOCK_TOGGLE, toggleLabel.c_str());
                        AppendMenuW(hMenu, MF_STRING, IDM_ADBLOCK_RELOAD, L"Reload filters");
                        AppendMenuW(hMenu, MF_SEPARATOR, 0, nullptr);

                        // Position popup under the button
                        RECT rc;
                        GetWindowRect(g_hwndFavoritesButton, &rc);
                        POINT pt;
                        pt.x = rc.left;
                        pt.y = rc.bottom;

                        // Use TPM_RETURNCMD so we get the selected command ID synchronously
                        int cmd = TrackPopupMenu(hMenu, TPM_RETURNCMD | TPM_LEFTALIGN | TPM_TOPALIGN, pt.x, pt.y, 0, hwnd, NULL);
                        DestroyMenu(hMenu);

                        if (cmd == IDM_ADBLOCK_TOGGLE) {
                            g_adBlockEnabled = !g_adBlockEnabled;
                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)(g_adBlockEnabled ? L"Ad-blocker: ON" : L"Ad-blocker: OFF"));
                            SaveFileSettings();
                        } else if (cmd == IDM_ADBLOCK_RELOAD) {
                            SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Reloading ad-block filters...");
                            // Try download+aggregate; if user declines or fails, still attempt to load existing filters
                            bool ok = DownloadAndAggregateFilters(hwnd);
                            LoadAdBlockFilters();
                            if (ok) {
                                SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Ad-block filters reloaded.");
                            } else {
                                SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Ad-block filters reload canceled/failed.");
                            }
                            // Reload the current page so new rules take effect immediately
                            if (g_webView) g_webView->Reload();
                        }
                    }
                    break;
                }
                case IDC_SETTINGS_BUTTON:
                    ShowSettingsWindow(hwnd);
                    break;
                case IDC_HELP_BUTTON: {
                    // Simple About/Help dialog (include the update date)
                    const wchar_t* aboutText = L"FlameDarkness Browser Beta 0.91\nMade by Local83 on 7 November 2025\nUpdated on 23 November 2025\n\nUse the toolbar to navigate. Open Settings for security options.\n\nReport issues: see the project repository.";
                    MessageBoxW(hwnd, aboutText, L"About / Help", MB_OK | MB_ICONINFORMATION);
                    break;
                }
                case IDC_PRIVACY_TEST_BUTTON: {
                    // Navigate to the privacy test page inside the browser
                    NavigateToUrl(L"https://webbrowsertools.com/privacy-test/");
                    SendMessage(g_hwndStatusBar, SB_SETTEXT, 1, (LPARAM)L"Opening privacy check...");
                    break;
                }
                case IDM_FILE_EXIT:
                    DestroyWindow(hwnd);
                    break;
            }
            break;
        }

        case WM_CLOSE:
            DestroyWindow(hwnd);
            break;

        case WM_DESTROY:
            PostQuitMessage(0);
            break;

        default:
            return DefWindowProc(hwnd, uMsg, wParam, lParam);
    }
    return 0;
}

// --- 9. WinMain Entry Point ---

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    
    // Initialize common controls (status bar and others)
    INITCOMMONCONTROLSEX icc = { sizeof(INITCOMMONCONTROLSEX), ICC_BAR_CLASSES | ICC_STANDARD_CLASSES };
    InitCommonControlsEx(&icc);

    // *** FIX: Initialize COM (Critical for WebView2) ***
    HRESULT hr = CoInitializeEx(nullptr, COINIT_APARTMENTTHREADED);
    if (FAILED(hr)) {
        return 0; 
    }

    const wchar_t CLASS_NAME[] = L"BrowserWindowClass";

    // Register the main window class
    WNDCLASSW wc = {};
    wc.lpfnWndProc = WindowProc;
    wc.hInstance = hInstance;
    wc.lpszClassName = CLASS_NAME;
    wc.hIcon = LoadIcon(NULL, IDI_APPLICATION);
    wc.hCursor = LoadCursor(NULL, IDC_ARROW);
    wc.hbrBackground = (HBRUSH)GetStockObject(WHITE_BRUSH);
    
    if (!RegisterClassW(&wc)) {
        CoUninitialize(); // Uninitialize before returning
        return 0;
    }

    // Create the main window
    g_hwndMain = CreateWindowExW(
        0, CLASS_NAME, L"FlameDarkness Browser Beta 0.91",
        WS_OVERLAPPEDWINDOW,
        CW_USEDEFAULT, CW_USEDEFAULT, WINDOW_WIDTH, WINDOW_HEIGHT,
        nullptr, nullptr, hInstance, nullptr
    );

    if (!g_hwndMain) {
        CoUninitialize(); // Uninitialize before returning
        return 0;
    }

    ShowWindow(g_hwndMain, nCmdShow);
    UpdateWindow(g_hwndMain);

    // Message loop
    MSG msg = {};
    while (GetMessage(&msg, nullptr, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    // FIX: Uninitialize COM
    CoUninitialize();

    return 0;
}